var Lapiz=Object.create(null);var Lapiz=(function ModuleLoaderModule(b){var c=Object.create(null);var a=[];function d(g){var h=[];var j;for(j=0;j<g.length;j++){if(c[g[j]]===undefined){h.push(g[j])}}return h}function f(g,h){Object.defineProperty(b,g,{value:h})}f("set",f);function e(j){var k,m,g;var h=[];var l=[];for(k=0;k<a.length;k++){m=a[k];g=m.reqs.indexOf(j);if(g!==-1){m.reqs.splice(g,1)}if(m.reqs.length===0){l.push(m)}else{h.push(m)}}a=h;for(k=0;k<l.length;k++){l[k].module(b);c[l[k].name]=true;e(l[k].name)}}b.set("Module",function(h,g,i){if(i===undefined){i=g;g=[]}g=d(g);if(g.length===0){i(b);c[h]=true;e(h)}else{a.push({module:i,name:h,reqs:g})}});b.Module.Loaded=function(){return Object.keys(c)};Object.freeze(self.Module);return b})(Lapiz);Lapiz.Module("Collections",function(a){a.each=function(f,d){var c;if(f instanceof Array){var b=f.length;for(c=0;c<b;c+=1){if(d(c,f[c])){return c}}}else{var e=Object.keys(f);for(c=e.length-1;c>=0;c-=1){if(d(e[c],f[e[c]])){return e[c]}}}return null};a.remove=function(b,d){var c=b.indexOf(d);if(c>-1){b.splice(c,1)}};a.ArrayConverter=function(c){var b=[];var d=[];c.each(function(e,f){b.push(f);d.push(e)});c.on.insert(function(f,e){b.push(e(f));d.push(f)});c.on.remove(function(g,h,e){var f=d.indexOf(g);d.splice(f,1);b.splice(f,1)});c.on.change(function(g,e){var f=d.indexOf(g);b[f]=e(g)});return b};a.Map=function(){return Object.create(null)};a.Namespace=function(){var b=a.Map();b.namespace=a.Map();function d(e,f){Object.defineProperty(b.namespace,e,{value:f})}function c(e){if(typeof e!=="function"){throw new Error("Expected function")}if(e.name===""){throw new Error("Methods require named functions")}b.set(e.name,e)}Object.defineProperty(b,"set",{value:d});Object.defineProperty(b,"method",{value:c});return b}});Lapiz.Module("Dependency",function(a){var b={};a.Dependency=function(c){var e=b[c];if(e===undefined){throw"Cannot find Dependency "+c}return e()};a.Dependency.Service=function(c,d){function e(f){return d.apply(this,f)}e.prototype=d.prototype;b[c]=function(){return new e(arguments)}};a.Dependency.Factory=function(c,d){b[c]=d};a.Dependency.Reference=function(c,d){b[c]=function(){return d}};a.Dependency.remove=function(c){delete b[c]};a.Dependency.has=function(c){return b.hasOwnProperty(c)}});Lapiz.Module("Dictionary",function(a){a.set("Dictionary",function(e){var d={};var h=0;var g=Lapiz.Event();var c=Lapiz.Event();var f=Lapiz.Event();if(e!==undefined){if(e.hasOwnProperty("each")){e.each(function(j,k){d[j]=k;h+=1})}else{a.each(e,function(j,k){d[j]=k;h+=1})}}var b=function(j,k){if(k===undefined){return d[j]}var i;if(!d.hasOwnProperty(j)){h+=1;i=g}else{i=f}d[j]=k;i.fire(j,b.Accessor);return k};b._cls=a.Dictionary;Object.defineProperty(b,"len",{get:function(){return h}});b.remove=function(j){if(d.hasOwnProperty(j)){h-=1;var i=d[j];delete d[j];c.fire(j,i,b.Accessor)}};b.on=a.Map();a.Event.LinkProperty(b.on,"insert",g);a.Event.LinkProperty(b.on,"change",f);a.Event.LinkProperty(b.on,"remove",c);Object.freeze(b.on);b.has=function(i){return d.hasOwnProperty(i)};b.each=function(l){var m=Object.keys(d);var k,j;for(j=m.length-1;j>=0;j-=1){k=m[j];if(l(k,d[k])){break}}};Object.defineProperty(b,"keys",{get:function(){return Object.keys(d)}});b.Sort=function(i){return a.Sort(b,i)};b.Filter=function(i,j){return a.Filter(b,i,j)};b.Accessor=function(i){return d[i]};b.Accessor.Accessor=b.Accessor;b.Accessor.len=b.len;b.Accessor.has=b.has;b.Accessor.each=b.each;b.Accessor.on=b.on;b.Accessor.Sort=b.Sort;b.Accessor.Filter=b.Filter;b.Accessor._cls=a.Accessor;Object.defineProperty(b.Accessor,"keys",{get:function(){return Object.keys(d)}});Object.defineProperty(b.Accessor,"len",{get:function(){return h}});Object.freeze(b.Accessor);Object.freeze(b);return b});a.set("Accessor",function(b){return b.Accessor})});Lapiz.Module("Events",function(a){a.Event=function(){var b=[];var c={register:function(d){b.push(d);return d},deregister:function(d){a.remove(b,d);return d},enabled:true,fire:function(){if(!c.enabled){return self}var e;var d=b.length;for(e=0;e<d;e+=1){b[e].apply(this,arguments)}return self},_cls:a.Event};c.register.deregister=c.deregister;Object.defineProperty(c,"length",{get:function(){return b.length}});return c};a.SingleEvent=function(){var c=a.Event();var e=false;var b;var d={register:function(f){if(e){f.apply(this,b)}else{c.register(f)}},deregister:function(f){if(e){return}c.deregister(f)},fire:function(){if(e){return}e=true;b=arguments;c.fire.apply(this,b);delete c},_cls:a.SingleEvent};Object.defineProperty(d,"enabled",{get:function(){return c.enabled},set:function(f){c.enabled=!!f}});return d};a.Event.LinkProperty=function(d,c,b){Object.defineProperty(d,c,{get:function(){return b.register},set:function(e){b.register(e)}})};a.on={}});Lapiz.Module("Filter",function(a){a.Filter=function(f,c,b){var j=[];var m=function(n){if(j.indexOf(n)>-1){return f(n)}};m._cls=a.Filter;var l=c;if(typeof(c)==="string"&&b!==undefined){l=function(o,n){return n(o)[c]===b}}var g=Lapiz.Event();var k=Lapiz.Event();var i=Lapiz.Event();f.each(function(n,o){if(l(n,f)){j.push(n)}});m.Accessor=m;m.Sort=function(n){return a.Sort(m,n)};m.Filter=function(n,o){return a.Filter(m,n,o)};m.has=function(n){return j.indexOf(n.toString())>-1};Object.defineProperty(m,"keys",{get:function(){return j.slice(0)}});Object.defineProperty(m,"len",{get:function(){return j.length}});m.each=function(p){var o;var n=j.length;for(o=0;o<n;o+=1){key=j[o];if(p(key,f(key))){break}}};m.on=a.Map();a.Event.LinkProperty(m.on,"insert",g);a.Event.LinkProperty(m.on,"change",i);a.Event.LinkProperty(m.on,"remove",k);Object.freeze(m.on);var e=function(o,n){o=o.toString();if(l(o,n)){j.push(o);g.fire(o,m)}};var d=function(p,q,n){p=p.toString();var o=j.indexOf(p);if(o>-1){j.splice(o,1);k.fire(p,q,m)}};var h=function(p,n){p=p.toString();var o=j.indexOf(p);var q=l(p,n);if(o>-1){if(q){i.fire(p,m)}else{j.splice(o,1);k.fire(p,n(p),m)}}else{if(q){j.push(p);g.fire(p,m)}}};f.on.insert(e);f.on.remove(d);f.on.change(h);Object.defineProperty(m,"func",{set:function(n){if(l.on!==undefined&&l.on.change!==undefined&&l.on.change.deregister!==undefined){l.on.change(m.ForceRescan)}l=n;m.ForceRescan()}});m.ForceRescan=function(){f.each(function(p,r){p=p.toString();var q=l(p,f);var o=j.indexOf(p);var n=(o!==-1);if(q&&!n){j.push(p);g.fire(p,m)}else{if(!q&&n){j.splice(o,1);k.fire(p,f(p),m)}}})};if(l.on!==undefined&&l.on.change!==undefined){l.on.change(m.ForceRescan)}m["delete"]=function(){f.on.insert.deregister(e);f.on.remove.deregister(d);f.on.change.deregister(h);if(l.on!==undefined&&l.on.change!==undefined&&l.on.change.deregister!==undefined){l.on.change(m.ForceRescan)}};Object.freeze(m);return m}});Lapiz.Module("Index",function(a){a.Index=function(d,c,f){if(c===undefined){c=function(g){return g.id}}else{if(typeof c==="string"){c=function(g){return function(h){return h[g]}}(c)}else{if(!(c instanceof Function)){throw ("Expected a function or string")}}}if(f===undefined){f=d}else{d[f]={};f=d[f]}var e=a.Dictionary();f.each=e.each;f.has=e.has;f.Filter=e.Filter;f.Sort=e.Sort;f.remove=e.remove;Object.defineProperty(f,"keys",{get:function(){return e.keys}});Object.defineProperty(f,"all",{get:function(){return e.Accessor}});function b(g){e(c(g),g)}d.on.create(function(g){g.on.change(b);g.on["delete"](function(h){h.on.change.deregister(b);e.remove(c(h))});b(g)});f.get=function(g,i){var h={};if(i!==undefined){e.each(function(j,k){if(k[g]===i){h[j]=k}});return h}else{if(g instanceof Function){e.each(function(j,k){if(g(k)){h[j]=k}});return h}}return e(g)}}});Lapiz.Module("Objects",["Events"],function(b){b.Object=function(){var c={};var e={};c.priv=e;c.on={};e.fire={};e.attr={};c._cls=b.Object;e.event=function(g){var h=b.Event();c.on[g]=h.register;h.register.deregister=h.deregister;Object.defineProperty(c.on,g,{get:function(){return h.register},set:function(i){h.register(i)}});e.fire[g]=h.fire;e.fire[g].disable=function(){h.enabled=false};e.fire[g].enable=function(){h.enabled=true};e.fire[g].enabled=function(){return h.enabled};e.fire[g].length=function(){return h.length};Object.defineProperty(e.fire[g],"length",{get:function(){return h.length}})};e.event("change");e.event("delete");e.setAll=function(h){var k,g;var j=Object.keys(h);e.fire.change.disable();for(g=j.length-1;g>=0;g-=1){k=j[g];if(c.hasOwnProperty(k)){c[k]=h[k]}}e.fire.change.enable();e.fire.change(c)};e.lock=function(){delete c.priv;delete c.lock};var f=function(g){if(g instanceof Function){return g}if(typeof(g)==="string"){return function(){return e.attr[g]}}};var d=function(h,g){if(typeof g==="string"){if(b.parse[g]===undefined){throw new Error("Lapiz.parse does not have field "+g)}else{g=b.parse[g]}}return function(){var j={set:true};var i=g.apply(j,arguments);if(j.set){e.attr[h]=i}e.fire.change(c)}};e.properties=function(j,g){var l,n,h,m;var k=Object.keys(j);for(h=k.length-1;h>=0;h-=1){l=k[h];n=j[l];m={};if(n===undefined||n===null){throw"Invalid value for '"+l+"'"}else{if(typeof n==="function"||typeof n==="string"){m.set=d(l,n);m.get=f(l)}else{if(n.set!==undefined||n.get!==undefined){if(n.set!==undefined){m.set=d(l,n.set)}if(n.get!==undefined){m.get=f(n.get)}else{m.get=f(l)}}else{if(n instanceof Array){m.set=d(l,n[0]);if(n[1]!==undefined){m.get=f(n[1])}else{m.get=f(l)}}else{throw"Could not construct getter/setter for "+n}}}}Object.defineProperty(c,l,m)}if(g!==undefined){e.setAll(g)}};e.argDict=function(){var j=arguments.callee.caller.arguments;var h=(arguments.callee.caller+"").match(/\([^)]*\)/g);var m={};var k,g;h=h[0].match(/[\w$]+/g);g=h.length;for(k=0;k<g;k+=1){m[h[k]]=j[k]}return m};return c};var a=b.Event();Object.defineProperty(b.on,"class",{get:function(){return a.register},set:function(c){a.register(c)}});b.Class=function(d){var f=Lapiz.Event();var c=function(){var e=d.apply(this,arguments);if(e===undefined){throw new Error("Constructor did not return an object")}f.fire(e);return e};c.on={create:f.register};a.fire(c);return c};b.Constructor=function(d,c){return b.Class(function(){var e=Lapiz.Object();if(c!==undefined){e.priv.properties(c)}d.apply(e,arguments);return e})}});Lapiz.Module("Parser",function(a){a.parse={"int":function(c,b){b=b||10;return parseInt(c,b)},string:function(d){if(d===undefined||d===null){return""}var c=typeof(d);if(c==="string"){return d}if(c==="number"){return""+d}var b;if("str" in d&&d.str instanceof Function){b=d.str()}else{if("toString" in d&&d.toString instanceof Function){b=d.toString()}}if(typeof b==="string"){return b}return""+d},bool:function(b){return !!b},number:function(b){return parseFloat(b)},object:function(b){return b},relational:function(f,e,d,b){var c=e.priv.attr;Object.defineProperty(e,d,{get:function(){return c[d]}});return function(g){g=f(g);c[d]=b(g);return g}}}});Lapiz.Module("Sorter",function(a){a.Sort=function(d,f){var l=function(m){return d(m)};l._cls=a.Sort;var j=d.keys;var e;var g=Lapiz.Event();var k=Lapiz.Event();var i=Lapiz.Event();if(f===undefined){e=function(n,m){n=d(n);m=d(m);return(n>m?1:(m>n?-1:0))};e.range=function(n,m){n=d(n);return(n>m?1:(m>n?-1:0))}}else{if(typeof(f)==="function"){e=function(n,m){return f(n,m,d)};if(f.range!==undefined){e.range=function(n,m){return f.range(n,m,d)}}}else{if(typeof(f)==="string"){e=function(n,m){n=d(n)[f];m=d(m)[f];return(n>m?1:(m>n?-1:0))};e.range=function(n,m){n=d(n)[f];return(n>m?1:(m>n?-1:0))}}}}j.sort(e);l.has=d.has;l.Accessor=d;l.Sort=d.Sort;l.Filter=d.Filter;Object.defineProperty(l,"keys",{get:function(){return j.slice(0)}});Object.defineProperty(l,"len",{get:function(){return d.len}});l.each=function(o){var n;var m=j.length;for(n=0;n<m;n+=1){key=j[n];if(o(key,d(key))){break}}};l.on=a.Map();a.Event.LinkProperty(l.on,"insert",g);a.Event.LinkProperty(l.on,"change",i);a.Event.LinkProperty(l.on,"remove",k);Object.freeze(l.on);Object.defineProperty(l,"func",{set:function(m){e=m;j.sort(e);d.each(function(o,n){i.fire(o,l)})}});var c=function(n,m){n=n.toString();j.splice(a.Sort.locationOf(n,j,e,m),0,n);g.fire(n,l)};var b=function(n,o,m){a.remove(j,n.toString());k.fire(n,o,l)};var h=function(n,m){n=n.toString();j.splice(j.indexOf(n),1);j.splice(a.Sort.locationOf(n,j,e,m),0,n);i.fire(n,l)};d.on.insert(c);d.on.remove(b);d.on.change(h);l["delete"]=function(){d.on.insert.deregister(c);d.on.remove.deregister(b);d.on.change.deregister(h)};if(e.range!==undefined){l.Range=function(o,m){m=m||o;var s=a.Sort.locationOf(o,j,e.range,d);var n=a.Sort.gt(m,j,e.range,d,s);var r=Lapiz.Dictionary();var q,p;for(q=s;q<n;q+=1){p=j[q];r(p,d(p))}return r}}Object.freeze(l);return l};a.Sort.locationOf=function(f,e,g,b,h,d){h=h||0;d=d||e.length;var c=Math.floor(h+(d-h)/2);if(d-h===0){return h}if(d-h===1){if(g(e[c],f,b)>=0){return h}return d}if(g(e[c],f,b)<=0){return a.Sort.locationOf(f,e,g,b,c,d)}else{return a.Sort.locationOf(f,e,g,b,h,c)}};a.Sort.gt=function(f,e,g,b,h,d){h=h||0;d=d||e.length;var c=Math.floor(h+(d-h)/2);if(d-h===0){return h}if(d-h===1){if(g(e[c],f,b)<0){return h}return d}if(g(e[c],f,b)<0){return a.Sort.locationOf(f,e,g,b,c,d)}else{return a.Sort.locationOf(f,e,g,b,h,c)}}});