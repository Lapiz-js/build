var Lapiz=(function(a){return a||Object.create(null)}(Lapiz));var Lapiz=(function ModuleLoaderModule(b){var c=Object.create(null);var a=[];function d(g){var h=[];var j;for(j=0;j<g.length;j++){if(c[g[j]]===undefined){h.push(g[j])}}return h}function f(i,g,h){Object.defineProperty(i,g,{value:h})}f(b,"set",f);function e(j){var k,m,g;var h=[];var l=[];for(k=0;k<a.length;k++){m=a[k];g=m.reqs.indexOf(j);if(g!==-1){m.reqs.splice(g,1)}if(m.reqs.length===0){l.push(m)}else{h.push(m)}}a=h;for(k=0;k<l.length;k++){l[k].module(b);c[l[k].name]=true;e(l[k].name)}}b.set(b,"Module",function(h,g,i){if(i===undefined){i=g;g=[]}g=d(g);if(g.length===0){i(b);c[h]=true;e(h)}else{a.push({module:i,name:h,reqs:g})}});b.Module.Loaded=function(){return Object.keys(c)};Object.freeze(self.Module);b.set(b,"typeCheck",function(j,h,i){var g=(typeof h==="string")?(typeof j===h):(j instanceof h);if(i!==undefined&&!g){throw new Error(i)}return g});b.set(b.typeCheck,"func",function(h,g){return b.typeCheck(h,Function,g)});b.set(b.typeCheck,"array",function(h,g){return b.typeCheck(h,Array,g)});b.set(b.typeCheck,"string",function(h,g){return b.typeCheck(h,"string",g)});b.set(b.typeCheck,"number",function(h,g){return b.typeCheck(h,"number",g)});b.set(b,"assert",function(g,h){if(!g){throw new Error(h)}});return b})(Lapiz);Lapiz.Module("Collections",function(e){function c(){return Object.create(null)}e.set(e,"Map",c);e.set(c,"meth",function(m,l){e.typeCheck.func(l,"Expected function");e.assert(l.name!=="","Require named function for method");e.set(m,l.name,l)});c.meth(c,function d(m,l){e.typeCheck.func(l,"Expected function for setterMethod");e.assert(l.name!=="","Require named function for setterMethod");Object.defineProperty(m,l.name,{get:function(){return l},set:l})});c.meth(c,function a(m,l,n){Object.defineProperty(m,l,n)});c.meth(c,function i(m,l){e.typeCheck.func(l,"Expected function for getter");e.assert(l.name!=="","Require named function for getter");Object.defineProperty(m,l.name,{get:l})});c.meth(c,function k(n,m,q,l){e.typeCheck.func(q,"Expected function for setterGetter");var p;var o={};if(l===undefined){o.get=function(){return p}}else{o.get=function(){return l(p,n)}}if(e.typeCheck.string(q)){q=e.parse[q]}o.set=function(r){var s={set:true};r=q.apply(s,[r,p,n]);if(s.set){p=r}};Object.defineProperty(n,m,o)});c.meth(c,function f(n,p){var o=2;var m=arguments.length;var q;for(;o<m;o+=1){q=arguments[o];if(q[0]==="&"){q=q.substr(1);Object.defineProperty(n,q,{get:(function(l){return function(){return p[l]}})(q),set:(function(l){return function(r){p[l]=r}})(q)})}else{n[q]=p[q]}}});c.meth(e,function h(o){var n=e.Map();n.namespace=e.Map();c.meth(n,function s(t,u){Object.defineProperty(n.namespace,t,{value:u})});c.meth(n,function r(t,u){Object.defineProperty(n.namespace,t,u)});c.meth(n,function m(t){c.meth(n.namespace,t)});c.meth(n,function p(t){c.setterMethod(n.namespace,t)});c.meth(n,function l(t){c.getter(n.namespace,t)});c.meth(n,function q(u,v,t){c.setterGetter(n.namespace,u,v,t)});if(e.typeCheck.func(o)){o.apply(n);return n.namespace}return n});c.meth(e,function g(l,n,o){var m=l.indexOf(n,o);if(m>-1){l.splice(m,1)}});c.meth(e,function j(q,o){var n;if(q instanceof Array){var m=q.length;for(n=0;n<m;n+=1){if(o(n,q[n])){return n}}return -1}else{var p=Object.keys(q);for(n=p.length-1;n>=0;n-=1){if(o(p[n],q[p[n]])){return p[n]}}}});c.meth(e,function b(m){var l=[];var n=[];m.each(function(o,p){l.push(p);n.push(o)});m.on.insert(function(p,o){l.push(o(p));n.push(p)});m.on.remove(function(q,r,o){var p=n.indexOf(q);n.splice(p,1);l.splice(p,1)});m.on.change(function(q,o){var p=n.indexOf(q);l[p]=o(q)});return l})});Lapiz.Module("Dependency",function(a){var b={};a.Dependency=function(c){var e=b[c];if(e===undefined){throw"Cannot find Dependency "+c}return e()};a.Dependency.Service=function(c,d){function e(f){return d.apply(this,f)}e.prototype=d.prototype;b[c]=function(){return new e(arguments)}};a.Dependency.Factory=function(c,d){b[c]=d};a.Dependency.Reference=function(c,d){b[c]=function(){return d}};a.Dependency.remove=function(c){delete b[c]};a.Dependency.has=function(c){return b.hasOwnProperty(c)}});Lapiz.Module("Dictionary",function(a){a.set(a,"Dictionary",function(c){var j=a.Map();var d=0;var e=Lapiz.Event();var g=Lapiz.Event();var f=Lapiz.Event();if(c!==undefined){if(c.hasOwnProperty("each")){c.each(function(k,l){j[k]=l;d+=1})}else{a.each(c,function(k,l){j[k]=l;d+=1})}}var i=function(k,m){if(m===undefined){return j[k]}var l;if(j[k]===undefined){d+=1;l=e}else{l=f}j[k]=m;l.fire(k,i.Accessor);return m};i._cls=a.Dictionary;a.Map.getter(i,function b(){return d});i.remove=function(k){if(j[k]!==undefined){d-=1;var l=j[k];delete j[k];g.fire(k,l,i.Accessor)}};i.on=a.Map();a.Event.linkProperty(i.on,"insert",e);a.Event.linkProperty(i.on,"change",f);a.Event.linkProperty(i.on,"remove",g);Object.freeze(i.on);i.has=function(k){return j[k]!==undefined};i.each=function(m){var n=Object.keys(j);var l,k;for(k=n.length-1;k>=0;k-=1){l=n[k];if(m(l,j[l])){break}}};a.Map.getter(i,function h(){return Object.keys(j)});i.Sort=function(k){return a.Sort(i,k)};i.Filter=function(k,l){return a.Filter(i,k,l)};i.Accessor=function(k){return j[k]};a.Map.copyProps(i.Accessor,i,"Accessor","&length","has","each","on","Sort","Filter","&keys");i.Accessor._cls=a.Accessor;Object.freeze(i.Accessor);Object.freeze(i);return i});a.set(a,"Accessor",function(b){return b.Accessor})});Lapiz.Module("Events",["Collections"],function(a){a.set(a,"Event",function(){var d=[];var f=Lapiz.Map();a.Map.setterMethod(f,function c(h){d.push(h);return h});a.Map.setterMethod(f.register,function g(h){a.remove(d,h);return h});a.Map.meth(f,function b(){if(!f.fire.enabled){return f}var j;var h=d.length;for(j=0;j<h;j+=1){d[j].apply(this,arguments)}return f});a.Map.setterGetter(f.fire,"enabled",function(h){return !!h});f.fire.enabled=true;a.Map.getter(f.fire,function e(){return d.length});a.set(f,"_cls",a.Event);return f});a.set(a,"SingleEvent",function(){var c=a.Event();var g=false;var b;var f=a.Map();a.Map.meth(f,function e(i){if(g){i.apply(this,b)}else{c.register(i)}});a.Map.meth(f.register,function h(i){if(g){return}c.register.deregister(i)});a.Map.meth(f,function d(){if(g){return}g=true;b=arguments;c.fire.apply(this,b);delete c});a.set(f,"_cls",a.SingleEvent);Object.defineProperty(f.fire,"enabled",{get:function(){return c.fire.enabled},set:function(i){c.fire.enabled=i}});return f});a.set(a.Event,"linkProperty",function(d,c,b){Object.defineProperty(d,c,{get:function(){return b.register},set:function(e){b.register(e)}})});a.on=a.Map()});Lapiz.Module("Filter",function(a){a.set(a,"Filter",function(g,d,c){var k=[];var o=function(p){if(k.indexOf(p)>-1){return g(p)}};o._cls=a.Filter;var n=d;if(a.typeCheck.string(d)&&c!==undefined){n=function(q,p){return p(q)[d]===c}}var h=Lapiz.Event();var l=Lapiz.Event();var j=Lapiz.Event();g.each(function(p,q){if(n(p,g)){k.push(p)}});o.Accessor=o;o.Sort=function(p){return a.Sort(o,p)};o.Filter=function(p,q){return a.Filter(o,p,q)};o.has=function(p){return k.indexOf(p.toString())>-1};a.Map.getter(o,function m(){return k.slice(0)});a.Map.getter(o,function b(){return k.length});o.each=function(r){var q;var p=k.length;for(q=0;q<p;q+=1){key=k[q];if(r(key,g(key))){break}}};o.on=a.Map();a.Event.linkProperty(o.on,"insert",h);a.Event.linkProperty(o.on,"change",j);a.Event.linkProperty(o.on,"remove",l);Object.freeze(o.on);var f=function(q,p){q=q.toString();if(n(q,p)){k.push(q);h.fire(q,o)}};var e=function(r,s,p){r=r.toString();var q=k.indexOf(r);if(q>-1){k.splice(q,1);l.fire(r,s,o)}};var i=function(r,p){r=r.toString();var q=k.indexOf(r);var s=n(r,p);if(q>-1){if(s){j.fire(r,o)}else{k.splice(q,1);l.fire(r,p(r),o)}}else{if(s){k.push(r);h.fire(r,o)}}};g.on.insert(f);g.on.remove(e);g.on.change(i);Object.defineProperty(o,"func",{set:function(p){if(n.on!==undefined&&n.on.change!==undefined&&n.on.change.deregister!==undefined){n.on.change(o.ForceRescan)}n=p;o.ForceRescan()}});o.ForceRescan=function(){g.each(function(r,t){r=r.toString();var s=n(r,g);var q=k.indexOf(r);var p=(q!==-1);if(s&&!p){k.push(r);h.fire(r,o)}else{if(!s&&p){k.splice(q,1);l.fire(r,g(r),o)}}})};if(n.on!==undefined&&n.on.change!==undefined){n.on.change(o.ForceRescan)}o["delete"]=function(){g.on.insert.deregister(f);g.on.remove.deregister(e);g.on.change.deregister(i);if(n.on!==undefined&&n.on.change!==undefined&&n.on.change.deregister!==undefined){n.on.change(o.ForceRescan)}};Object.freeze(o);return o})});Lapiz.Module("Index",function(a){a.set(a,"Index",function(d,c,f){if(c===undefined){c=function(g){return g.id}}else{if(typeof c==="string"){c=function(g){return function(h){return h[g]}}(c)}else{if(!(c instanceof Function)){throw ("Expected a function or string")}}}if(f===undefined){f=d}else{d[f]={};f=d[f]}var e=a.Dictionary();f.each=e.each;f.has=e.has;f.Filter=e.Filter;f.Sort=e.Sort;f.remove=e.remove;Object.defineProperty(f,"keys",{get:function(){return e.keys}});Object.defineProperty(f,"all",{get:function(){return e.Accessor}});function b(g){e(c(g),g)}d.on.create(function(g){g.on.change(b);g.on["delete"](function(h){h.on.change.deregister(b);e.remove(c(h))});b(g)});f.get=function(g,i){var h={};if(i!==undefined){e.each(function(j,k){if(k[g]===i){h[j]=k}});return h}else{if(g instanceof Function){e.each(function(j,k){if(g(k)){h[j]=k}});return h}}return e(g)}})});Lapiz.Module("Objects",["Events"],function(e){function c(f,g){if(e.typeCheck.func(g)){return g}if(e.typeCheck.string(g)){return function(){return f.attr[g]}}}function b(f,h,g){if(e.typeCheck.string(g)){e.assert(e.parse[g]!==undefined,"Lapiz.parse does not have field "+g);g=e.parse[g]}return function(){var k={set:true,fireChange:true,event:undefined};var j=g.apply(k,arguments);if(k.set){var i=f.attr[h];f.attr[h]=j;if(k.fireChange){f.fire.change(f.pub)}if(typeof k.event==="function"){event(f,j,i)}}}}e.Object=function(h){var f=e.Map();var i=e.Map();f.pub=i;f.pub.on=e.Map();f.fire=e.Map();f.attr=e.Map();f._cls=e.Object;f.event=function(j){var k=e.Event();e.Event.linkProperty(f.pub.on,j,k);f.fire[j]=k.fire};f.event("change");f.event("delete");f.setMany=function g(l){var n,k;var m=Object.keys(l);var j=f.fire.change.enabled;f.fire.change.enabled=false;for(k=m.length-1;k>=0;k-=1){n=m[k];if(Object.hasOwnProperty.call(f.pub,n)){f.pub[n]=l[n]}}f.fire.change.enabled=j;f.fire.change(f.pub)};f.properties=function(l,j){var n,p,k,o;var m=Object.keys(l);for(k=m.length-1;k>=0;k-=1){n=m[k];p=l[n];o={};if(p===undefined||p===null){throw new Error("Invalid value for '"+n+"'")}else{if(e.typeCheck.func(p)||e.typeCheck.string(p)){o.set=b(f,n,p);o.get=c(f,n)}else{if(p.set!==undefined||p.get!==undefined){if(p.set!==undefined){o.set=b(f,n,p.set)}o.get=(p.get!==undefined)?c(f,p.get):c(f,n)}else{throw new Error("Could not construct getter/setter for "+p)}}}Object.defineProperty(f.pub,n,o)}if(j!==undefined){f.setMany(j)}};f.getter=function(j){e.Map.getter(f.pub,j)};f.meth=function(j){e.Map.meth(f.pub,j)};if(e.typeCheck.func(h)){h.apply(f)}return f};e.Map.meth(e,function d(){var h=arguments.callee.caller.arguments;var g=(arguments.callee.caller+"").match(/\([^)]*\)/g);var k={};var j,f;g=g[0].match(/[\w$]+/g);f=g.length;for(j=0;j<f;j+=1){k[g[j]]=h[j]}return k});var a=e.Event();e.Event.linkProperty(e.on,"class",a);e.Class=function(i,g){g=!!g;var f=Lapiz.Event();var h;if(g){h=function(){var j=i.apply(this,arguments);if(j===undefined){throw new Error("Constructor did not return an object")}f.fire(j);return j}}else{h=function(){var j=Lapiz.Object();j=i.apply(j,arguments)||j;f.fire(j);return j}}h.on=e.Map();e.Event.linkProperty(h.on,"create",f);a.fire(h);return h}});Lapiz.Module("Parser",function(f){function d(h){if(f.typeCheck.string(h)&&f.parse[h]!==undefined){return f.parse[h]}return h}f.set(f,"parse",f.Map());f.set(f.parse,"int",function(i,h){if(i===true){return 1}else{if(i===false){return 0}}h=h||10;return parseInt(i,h)});f.Map.meth(f.parse,function c(j){if(j===undefined||j===null){return""}var i=typeof(j);if(i==="string"){return j}if(i==="number"){return""+j}var h;if("str" in j&&j.str instanceof Function){h=j.str()}else{if("toString" in j&&j.toString instanceof Function){h=j.toString()}}if(typeof h==="string"){return h}return""+j});f.Map.meth(f.parse,function a(h){return !!h});f.Map.meth(f.parse,function e(h){return parseFloat(h)});f.Map.meth(f.parse,function b(h){return h});f.Map.meth(f.parse,function g(h){h=d(h);return function(j){if(Array.isArray(j)){for(var k=0;k<j.length;k++){j[k]=h(j[k])}return j}return[h(j)]}})});Lapiz.Module("Sorter",function(a){a.set(a,"Sort",function(d,f){var m=function(n){return d(n)};m._cls=a.Sort;var j=d.keys;var e;var g=Lapiz.Event();var k=Lapiz.Event();var i=Lapiz.Event();if(f===undefined){e=function(o,n){o=d(o);n=d(n);return(o>n?1:(n>o?-1:0))};e.range=function(o,n){o=d(o);return(o>n?1:(n>o?-1:0))}}else{if(typeof(f)==="function"){e=function(o,n){return f(o,n,d)};if(f.range!==undefined){e.range=function(o,n){return f.range(o,n,d)}}}else{if(typeof(f)==="string"){e=function(o,n){o=d(o)[f];n=d(n)[f];return(o>n?1:(n>o?-1:0))};e.range=function(o,n){o=d(o)[f];return(o>n?1:(n>o?-1:0))}}}}j.sort(e);a.Map.copyProps(m,d,"has","Accessor","Sort","Filter","&length");a.Map.getter(m,function l(){return j.slice(0)});m.each=function(p){var o;var n=j.length;for(o=0;o<n;o+=1){key=j[o];if(p(key,d(key))){break}}};m.on=a.Map();a.Event.linkProperty(m.on,"insert",g);a.Event.linkProperty(m.on,"change",i);a.Event.linkProperty(m.on,"remove",k);Object.freeze(m.on);Object.defineProperty(m,"func",{set:function(n){e=n;j.sort(e);d.each(function(p,o){i.fire(p,m)})}});var c=function(o,n){o=o.toString();j.splice(a.Sort.locationOf(o,j,e,n),0,o);g.fire(o,m)};var b=function(o,p,n){a.remove(j,o.toString());k.fire(o,p,m)};var h=function(o,n){o=o.toString();j.splice(j.indexOf(o),1);j.splice(a.Sort.locationOf(o,j,e,n),0,o);i.fire(o,m)};d.on.insert(c);d.on.remove(b);d.on.change(h);m["delete"]=function(){d.on.insert.deregister(c);d.on.remove.deregister(b);d.on.change.deregister(h)};if(e.range!==undefined){m.Range=function(p,n){n=n||p;var t=a.Sort.locationOf(p,j,e.range,d);var o=a.Sort.gt(n,j,e.range,d,t);var s=Lapiz.Dictionary();var r,q;for(r=t;r<o;r+=1){q=j[r];s(q,d(q))}return s}}Object.freeze(m);return m});a.Sort.locationOf=function(f,e,g,b,h,d){h=h||0;d=d||e.length;var c=Math.floor(h+(d-h)/2);if(d-h===0){return h}if(d-h===1){return(g(e[c],f,b)>=0)?h:d}return(g(e[c],f,b)<=0)?a.Sort.locationOf(f,e,g,b,c,d):a.Sort.locationOf(f,e,g,b,h,c)};a.Sort.gt=function(f,e,g,b,h,d){h=h||0;d=d||e.length;var c=Math.floor(h+(d-h)/2);if(d-h===0){return h}if(d-h===1){return(g(e[c],f,b)<0)?h:d}return(g(e[c],f,b)<0)?a.Sort.locationOf(f,e,g,b,c,d):a.Sort.locationOf(f,e,g,b,h,c)}});