var Lapiz=(function($L){return $L||Object.create(null);}(Lapiz));(function ModuleLoaderModule($L){var _loaded=Object.create(null);var _pending=[];function set(obj,name,value){if(value===undefined&&typeof name==="function"&&name.name!==""){value=name;name=value.name;}
if(typeof name!=="string"){if($L.Err){$L.Err.toss("Attempting to call Lapiz.set without name");}else{throw new Error("Attempting to call Lapiz.set without name");}}
if(value===undefined){if($L.Err){$L.Err.toss("Attempting to call Lapiz.set without value");}else{throw new Error("Attempting to call Lapiz.set without value");}}
var setErr="Attempting to set read-only property "+name;Object.defineProperty(obj,name,{"get":function(){return value;},"set":function(){throw new Error(setErr);},});}
set($L,set);set($L,"_cls",$L);function _updatePending(name){var i,pending,idx;var stillPending=[];var ready=[];for(i=0;i<_pending.length;i++){pending=_pending[i];idx=pending.reqs.indexOf(name);if(idx!==-1){pending.reqs.splice(idx,1);}
if(pending.reqs.length===0){ready.push(pending);}else{stillPending.push(pending);}}
_pending=stillPending;for(i=0;i<ready.length;i++){ready[i].module($L);_loaded[ready[i].name]=true;_updatePending(ready[i].name);}}
function _checkReqs(reqs){var notLoaded=[];var i;for(i=0;i<reqs.length;i++){if(_loaded[reqs[i]]===undefined){notLoaded.push(reqs[i]);}}
return notLoaded;};$L.set($L,"Module",function(name,reqs,module){if(module===undefined){module=reqs;reqs=[];}
reqs=_checkReqs(reqs);if(reqs.length===0){module($L);_loaded[name]=true;_updatePending(name);}else{_pending.push({module:module,name:name,reqs:reqs});}});Object.defineProperty($L.Module,"Loaded",{"get":function(){return Object.keys(_loaded);}});Object.freeze(self.Module);$L.set($L,function typeCheck(obj,type,err){var typeCheck=false;try{typeCheck=(typeof type==="string")?(typeof obj===type):(obj instanceof type);}catch(e){throw new Error("typeCheck error, type arg is probably not instance class");}
if(err!==undefined&&!typeCheck){err=new Error(err);if($L.Err&&$L.Err.toss){$L.Err.toss(err)}else{throw err;}}
return typeCheck;});$L.set($L.typeCheck,function func(obj,err){return $L.typeCheck(obj,"function",err);});$L.set($L.typeCheck,function arr(obj,err){return $L.typeCheck(obj,Array,err);});$L.set($L.typeCheck,function str(obj,err){return $L.typeCheck(obj,"string",err);});$L.set($L.typeCheck,function number(obj,err){return $L.typeCheck(obj,"number",err);});$L.set($L.typeCheck,function obj(obj,err){return $L.typeCheck(obj,"object",err);});$L.set($L.typeCheck,function nested(){var args=Array.prototype.slice.call(arguments);$L.assert(args.length>=2,"Lapiz.typeCheck.nested requres at least 2 arguments");var typeCheckFn=args.pop();typeCheckFn=$L.typeCheck.str(typeCheckFn)?$L.typeCheck[typeCheckFn]:typeCheckFn;$L.typeCheck.func(typeCheckFn,"Last argument to Lapiz.typeCheck.nested must be a function or name of a typeCheck helper method");var obj;for(obj=args.shift();obj!==undefined&&args.length>0;obj=obj[args.shift()]);return typeCheckFn(obj);});$L.set($L,function assert(bool,err){if(!bool){err=new Error(err);err.stack=err.stack.split("\n");err.stack.shift();err.stack=err.stack.join("\n");if($L.Err&&$L.Err.toss){$L.Err.toss(err);}else{throw err;}}});})(Lapiz);Lapiz.Module("Collections",function($L){function Map(){return Object.create(null);}
$L.set($L,"Map",Map);$L.set($L,function getFnName(fn){var name=fn.name;$L.assert(name!=="","Expected named function, got anonymous");name=name.split(" ").pop();return name;});$L.set($L.set,function meth(obj,name,fn,bind){if(name===undefined&&$L.typeCheck.func(obj)){$L.Err.toss("Meth called without object: "+obj.name);}
if($L.typeCheck.func(fn)&&$L.typeCheck.str(name)){$L.assert(name!=="","Meth name cannot be empty string");}else if($L.typeCheck.func(name)&&name.name!==""){bind=fn;fn=name;name=$L.getFnName(fn);}else{Lapiz.Err.toss("Meth requires either name and func or named function");}
if(bind!==undefined){fn=fn.bind(bind);}
$L.set(obj,name,fn);});$L.set.meth($L.set,function prop(obj,name,desc){Object.defineProperty(obj,name,desc);});$L.set.meth($L.set,function setterMethod(obj,name,fn,bind){if(name===undefined&&$L.typeCheck.func(obj)){Lapiz.Err.toss("SetterMethod called without object: "+obj.name);}
if($L.typeCheck.func(fn)&&$L.typeCheck.str(name)){$L.assert(name!=="","SetterMethod name cannot be empty string");}else if($L.typeCheck.func(name)&&name.name!==""){bind=fn;fn=name;name=$L.getFnName(fn);}else{Lapiz.Err.toss("SetterMethod requires either name and func or named function");}
if(bind!==undefined){fn=fn.bind(bind);}
$L.set.prop(obj,name,{"get":function(){return fn;},"set":fn});});$L.set.meth(Map,function has(obj,field){return Object.hasOwnProperty.call(obj,field);});$L.set.meth($L.set,function getter(obj,name,fn){if(name===undefined&&$L.typeCheck.func(obj)){Lapiz.Err.toss("Getter called without object: "+obj.name);}
if($L.typeCheck.func(fn)&&$L.typeCheck.str(name)){$L.assert(name!=="","Getter name cannot be empty string");}else if($L.typeCheck.func(name)&&name.name!==""){fn=name;name=$L.getFnName(fn);}else if($L.typeCheck.arr(name)){$L.each(name,function(getterFn){$L.set.getter(obj,getterFn);});return;}else if($L.typeCheck.obj(name)){$L.each(name,function(getterFn,name){$L.set.getter(obj,name,getterFn);});return;}else{Lapiz.Err.toss("Getter requires either name and func or named function");}
$L.set.prop(obj,name,{"get":fn});});$L.set.meth($L.set,function setterGetter(obj,name,val,setter,getter){if($L.typeCheck.str(setter)){setter=$L.parse(setter);}
$L.typeCheck.func(setter,"Expected function or string reference to parser for setterGetter (argument 4)");var desc={};if(getter===undefined){desc.get=function(){return val;};}else{$L.typeCheck.func(getter,"Getter must be undefined or a function");desc.get=function(){return getter(val,obj);};}
desc.set=function(newVal){var setterInterface={"set":true};newVal=setter.apply(setterInterface,[newVal,val,obj]);if(setterInterface.set){val=newVal;}};$L.set.prop(obj,name,desc);});$L.set.meth($L.set,function copyProps(copyTo,copyFrom){var i=2;var l=arguments.length;var prop;for(;i<l;i+=1){prop=arguments[i];if(prop[0]==="&"){prop=prop.substr(1);Object.defineProperty(copyTo,prop,{"get":(function(prop){return function(){return copyFrom[prop];};})(prop),"set":(function(prop){return function(val){copyFrom[prop]=val;};})(prop)});}else{copyTo[prop]=copyFrom[prop];}}});$L.set.meth($L.set,function getterFactory(attr,funcOrProp){if($L.typeCheck.func(funcOrProp)){return funcOrProp;}
if($L.typeCheck.str(funcOrProp)){return function(){return attr[funcOrProp];};}
Lapiz.Err.toss("Getter value for property must be either a function or string");});$L.set.meth($L.set,function setterFactory(self,attr,field,func,callback){if($L.typeCheck.str(func)){func=$L.parse(func);}
return function(){var setterInterface={set:true,fire:true,callback:undefined,self:self,};var val=func.apply(setterInterface,arguments);if(setterInterface.set){var oldVal=attr[field];attr[field]=val;if(setterInterface.fire&&$L.typeCheck.func(callback)){callback(self,field);}
if($L.typeCheck.func(setterInterface.callback)){setterInterface.callback(self,field,val,oldVal);}}};});function _setReadOnly(){$L.Err.toss("Cannot set readonly property");};function _setOnce(setter){var isSet=false;return function(val){if(isSet){_setReadOnly();}
isSet=true;return setter(val);};}
$L.set.meth($L.set,function setProperties(obj,attr,properties,values,callback){if(obj===undefined){$L.Err.toss("Got undefined for obj in setProperties");}
if(callback===undefined&&$L.typeCheck.func(values)){callback=values;values=undefined;}
var property,val,i,desc,isSetOnce,isGetter;var keys=Object.keys(properties);for(i=keys.length-1;i>=0;i-=1){property=keys[i];val=properties[property];desc=$L.Map();if(property[0]==="+"){property=property.slice(1);if(val===undefined||val===null){desc.get=$L.set.getterFactory(attr,property);}else if($L.typeCheck.func(val)){desc.get=val;}
desc.set=_setReadOnly;Object.defineProperty(obj,property,desc);if(values&&Object.hasOwnProperty.call(values,property)){attr[property]=values[property];}}else{isSetOnce=false;if(property[0]==="*"){property=property.slice(1);isSetOnce=true;}
if(val===undefined||val===null){$L.Err.toss("Invalid value for '"+property+"'");}else if($L.typeCheck.func(val)||$L.typeCheck.str(val)){desc.set=$L.set.setterFactory(obj,attr,property,val,callback);desc.get=$L.set.getterFactory(attr,property);}else if(val.set!==undefined||val.get!==undefined){if(val.set!==undefined){desc.set=$L.set.setterFactory(obj,attr,property,val.set,callback);}
desc.get=(val.get!==undefined)?$L.set.getterFactory(attr,val.get):$L.set.getterFactory(attr,property);}else{$L.Err.toss("Could not construct getter/setter for "+property);}
if(isSetOnce){desc.set=_setOnce(desc.set);}
Object.defineProperty(obj,property,desc);if(values&&Object.hasOwnProperty.call(values,property)){desc.set(values[property]);}}}});$L.set.meth($L.set,function binder(proto,name,fn){if(fn===undefined){fn=name;name=$L.getFnName(fn);}
$L.typeCheck.func(fn,"Expected fn for binder");if(!$L.typeCheck.str(name)||name===""){$L.Err.toss("Invalid name for binder function");}
Object.defineProperty(proto,name,{get:function(){var bfn=fn.bind(this);$L.set.meth(this,name,bfn);return bfn;},set:function(){$L.Err.toss("Cannot reassign method "+name);},});});var _nsProto=Map();$L.set.binder(_nsProto,function properties(props,vals){$L.set.setProperties(this.namespace,this.attr,props,vals);});$L.set.binder(_nsProto,function meth(name,fn){if(fn===undefined){$L.set.meth(this.namespace,name,this);}else{$L.set.meth(this.namespace,name,fn,this);}});$L.set.binder(_nsProto,function set(name,val){Object.defineProperty(this.namespace,name,{'value':val});});$L.set.binder(_nsProto,function setterMethod(name,fn){if(fn===undefined){$L.set.setterMethod(this.namespace,name,this);}else{$L.set.setterMethod(this.namespace,name,fn,this);}});$L.set($L,function Namespace(fn){var self=Object.create(_nsProto);$L.set(self,'namespace',$L.Map());$L.set(self,'attr',$L.Map());if($L.typeCheck.func(fn)){fn.call(self);return self.namespace;}
return self;});$L.set.meth($L,function remove(arr,el,start){var i=arr.indexOf(el,start);if(i>-1){arr.splice(i,1);}});$L.set.meth($L,function each(obj,fn){$L.typeCheck.func(fn,"Second argument to each must be a function");if(obj===undefined||obj===null){return undefined;}
var i;if($L.typeCheck.arr(obj)){var l=obj.length;for(i=0;i<l;i+=1){if(fn(obj[i],i,obj)){return i;}}
return-1;}
var keys=Object.keys(obj);for(i=keys.length-1;i>=0;i-=1){if(fn(obj[keys[i]],keys[i],obj)){return keys[i];}}
return undefined;});$L.set.meth($L,function ArrayConverter(accessor){var arr=[];var index=[];accessor.each(function(obj,key){arr.push(obj);index.push(key);});accessor.on.insert(function(key,accessor){arr.push(accessor(key));index.push(key);});accessor.on.remove(function(key,obj,accessor){var i=index.indexOf(key);index.splice(i,1);arr.splice(i,1);});accessor.on.change(function(key,accessor){var i=index.indexOf(key);arr[i]=accessor(key);});return arr;});$L.set.meth($L,function argMap(levels){levels=levels||0;var caller=arguments.callee.caller;var map=$L.Map();while(levels>0){levels--;caller=caller.caller;if(caller===undefined||caller===null){return map;}}
var args=caller.arguments;var argNames=(caller+"").match(/\([^)]*\)/g);var i,l;argNames=argNames[0].match(/[\w$]+/g);l=argNames.length;for(i=0;i<l;i+=1){map[argNames[i]]=args[i];}
return map;});});Lapiz.Module("Dependency",function($L){var _dependencies={};$L.Dependency=function(name){var d=_dependencies[name];if(d===undefined){Lapiz.Err.toss("Cannot find Dependency "+name);}
return d();};$L.Dependency.Service=function(name,fn){function F(args){return fn.apply(this,args);}
F.prototype=fn.prototype;_dependencies[name]=function(){return new F(arguments);};};$L.Dependency.Factory=function(name,fn){_dependencies[name]=fn;};$L.Dependency.Reference=function(name,res){_dependencies[name]=function(){return res;};};$L.Dependency.remove=function(name){delete _dependencies[name];};$L.Dependency.has=function(name){return _dependencies.hasOwnProperty(name);};});Lapiz.Module("Dictionary",function($L){$L.set($L,"Dictionary",function(val){var _dict=$L.Map();var _length=0;if(val!==undefined){if($L.typeCheck.func(val.each)){val.each(function(val,key){_dict[key]=val;_length+=1;});}else{$L.each(val,function(val,key){_dict[key]=val;_length+=1;});}}
var self=function(key,val){if(val===undefined){try{return _dict[key];}catch(err){Lapiz.Err.toss(err);}}
var oldVal=_dict[key];_dict[key]=val;if(oldVal===undefined){_length+=1;_insertEvent.fire(key,self.Accessor);}else{_changeEvent.fire(key,self.Accessor,oldVal);}
return val;};$L.set(self,"_cls",$L.Dictionary);self.on=$L.Map();var _insertEvent=$L.Event.linkProperty(self.on,"insert");var _removeEvent=$L.Event.linkProperty(self.on,"remove");var _changeEvent=$L.Event.linkProperty(self.on,"change",_changeEvent);Object.freeze(self.on);$L.set.getter(self,function length(){return _length;});self.remove=function(key){if(_dict[key]!==undefined){_length-=1;var obj=_dict[key];delete _dict[key];_removeEvent.fire(key,self.Accessor,obj);}};self.has=function(key){return _dict[key]!==undefined;};self.each=function(fn){var keys=Object.keys(_dict);var key,i;for(i=keys.length-1;i>=0;i-=1){key=keys[i];if(fn(_dict[key],key)){return key;}}};$L.set.getter(self,function keys(){return Object.keys(_dict);});self.Sort=function(funcOrField){return $L.Sort(self,funcOrField);};self.Filter=function(filterOrAttr,val){return $L.Filter(self,filterOrAttr,val);};self.Accessor=function(key){return _dict[key];};$L.set.copyProps(self.Accessor,self,"Accessor","&length","has","each","on","Sort","Filter","&keys");self.Accessor._cls=$L.Accessor;Object.freeze(self.Accessor);Object.freeze(self);return self;});$L.set($L,"Accessor",function(accessor){return accessor.Accessor;});});Lapiz.Module("Errors",["Events","Collections"],function($L){$L.set($L,"Err",$L.Map());var _errEvent=$L.Event.linkProperty($L.on,"error");$L.set($L.Err,"toss",function(err){if($L.typeCheck.str(err)){err=new Error(err);}
_errEvent.fire(err);throw err;});function logError(err){$L.Err.logTo.log(err.message);$L.Err.logTo.log(err.stack);}
var _loggingEnabled=false;var _nullLogger=$L.Map();$L.set.meth(_nullLogger,function log(){});Object.freeze(_nullLogger);$L.set.setterGetter($L.Err,"logTo",_nullLogger,function(newVal,oldVal){if(newVal===null||newVal===undefined){newVal=_nullLogger;if(_loggingEnabled){_loggingEnabled=false;$L.on.error.deregister(logError);}}else{$L.typeCheck.func(newVal.log,"Object passed to Lapiz.Err.logTo must have .log method");if(!_loggingEnabled){_loggingEnabled=true;$L.on.error(logError);}}
return newVal;});});Lapiz.Module("Events",["Collections"],function($L){$L.set($L,"Event",function(){var _listeners=[];var event=Lapiz.Map();$L.set.setterMethod(event,function register(fn){$L.typeCheck.func(fn,"Event registration requires a function");_listeners.push(fn);return fn;});$L.set.setterMethod(event.register,function deregister(fn){$L.remove(_listeners,fn);return fn;});$L.set.meth(event,function fire(){if(!event.fire.enabled){return event;}
var i;var listeners=_listeners.slice(0);var l=listeners.length;for(i=0;i<l;i+=1){listeners[i].apply(this,arguments);}
return event;});$L.set.setterGetter(event.fire,"enabled",true,function(enable){return!!enable;});$L.set.getter(event.fire,function length(){return _listeners.length;});$L.set(event,"_cls",$L.Event);return event;});$L.set($L,"SingleEvent",function(){var _event=$L.Event();var _hasFired=false;var _args;var facade=$L.Map();$L.set.meth(facade,function register(fn){if(_hasFired){fn.apply(this,_args);}else{_event.register(fn);}});$L.set.meth(facade.register,function deregister(fn){if(_hasFired){return;}
_event.register.deregister(fn);});$L.set.meth(facade,function fire(){if(_hasFired||!_event.fire.enabled){return;}
_hasFired=true;_args=arguments;_event.fire.apply(this,_args);delete _event;});$L.set(facade,"_cls",$L.SingleEvent);Object.defineProperty(facade.fire,"enabled",{get:function(){return _event.fire.enabled;},set:function(val){_event.fire.enabled=val;}});return facade;});$L.set($L.Event,"linkProperty",function(obj,name,evt){if(evt===undefined){evt=$L.Event();}
Object.defineProperty(obj,name,{get:function(){return evt.register;},set:function(fn){evt.register(fn);}});return evt;});$L.set($L,"on",$L.Map());});Lapiz.Module("Filter",function($L){$L.set($L,"Filter",function(accessor,filterOrField,val){var _index=[];var self=function(key){if(_index.indexOf(key)>-1){return accessor(key);}};$L.set(self,"_cls",$L.Filter);var filterFn=filterOrField;if($L.typeCheck.str(filterOrField)&&val!==undefined){filterFn=function(key,accessor){return accessor(key)[filterOrField]===val;};}
$L.typeCheck.func(filterFn,"Filter must be invoked with function or attriubte and value");accessor.each(function(val,key){if(filterFn(key,accessor)){_index.push(key);}});$L.set(self,"Accessor",self);$L.set.meth(self,function Sort(funcOrField){return $L.Sort(self,funcOrField);});$L.set.meth(self,function Filter(filterOrField,val){return $L.Filter(self,filterOrField,val);});$L.set.meth(self,function has(key){return _index.indexOf(key.toString())>-1;});$L.set.getter(self,function keys(){return _index.slice(0);});$L.set.getter(self,function length(){return _index.length;});$L.set.meth(self,function each(fn){var i;var l=_index.length;for(i=0;i<l;i+=1){key=_index[i];if(fn(accessor(key),key)){return key;}}});$L.set(self,"on",$L.Map());var _insertEvent=$L.Event.linkProperty(self.on,"insert");var _changeEvent=$L.Event.linkProperty(self.on,"change");var _removeEvent=$L.Event.linkProperty(self.on,"remove");Object.freeze(self.on);function inFn(key,accessor){key=key.toString();if(filterFn(key,accessor)){_index.push(key);_insertEvent.fire(key,self);}}
function remFn(key,accessor,oldVal){key=key.toString();var i=_index.indexOf(key);if(i>-1){_index.splice(i,1);_removeEvent.fire(key,self,oldVal);}}
function changeFn(key,accessor,oldVal){key=key.toString();var i=_index.indexOf(key);var f=filterFn(key,accessor);if(i>-1){if(f){_changeEvent.fire(key,self,oldVal);}else{_index.splice(i,1);_removeEvent.fire(key,accessor(key),self);}}else{if(f){_index.push(key);_insertEvent.fire(key,self);}}}
accessor.on.insert(inFn);accessor.on.remove(remFn);accessor.on.change(changeFn);$L.set.meth(self,function ForceRescan(){accessor.each(function(val,key){key=key.toString();var willBeInSet=filterFn(key,accessor);var idx=_index.indexOf(key)
var isInSet=(idx!==-1);if(willBeInSet&&!isInSet){_index.push(key);_insertEvent.fire(key,self);}else if(!willBeInSet&&isInSet){_index.splice(idx,1);_removeEvent.fire(key,accessor(key),self);}});});$L.set.setterMethod(self,function func(fn){if($L.typeCheck.nested(filterFn,"on","change","deregister","func")){filterFn.on.change.deregister(self.ForceRescan);}
filterFn=fn;if($L.typeCheck.nested(filterFn,"on","change","func")){filterFn.on.change(self.ForceRescan);}
self.ForceRescan();});if($L.typeCheck.nested(filterFn,"on","change","func")){filterFn.on.change(self.ForceRescan);}
$L.set.meth(self,function kill(){accessor.on.insert.deregister(inFn);accessor.on.remove.deregister(remFn);accessor.on.change.deregister(changeFn);if($L.typeCheck.nested(filterFn,"on","change","deregister","func")){filterFn.on.change.deregister(self.ForceRescan);}});Object.freeze(self);return self;});});Lapiz.Module("Index",function($L){$L.set($L,"Index",function(cls,primaryFunc,domain){if(primaryFunc===undefined){primaryFunc=function(obj){return obj[$L.Index.defaultPrimary];};}else if($L.typeCheck.str(primaryFunc)){primaryFunc=function(field){return function(obj){return obj[field];};}(primaryFunc);}else if(!$L.typeCheck.func(primaryFunc)){Lapiz.Err.toss("Expected a function or string");}
if(domain===undefined){domain=cls;}else{cls[domain]=$L.Map();domain=cls[domain];}
var _primary=$L.Dictionary();domain.each=_primary.each;domain.has=_primary.has;domain.Filter=_primary.Filter;domain.Sort=_primary.Sort;domain.remove=_primary.remove;Object.defineProperty(domain,"keys",{get:function(){return _primary.keys;}});Object.defineProperty(domain,"all",{get:function(){return _primary.Accessor;}});function _upsert(obj){_primary(primaryFunc(obj),obj);}
cls.on.create(function(obj){if($L.typeCheck.nested(domain,"exclude","func")&&domain.exclude(obj)){return;}
obj.on.change(_upsert);obj.on.remove(function(obj){if($L.typeCheck.nested(obj,"on","change","deregister","func")){obj.on.change.deregister(_upsert);}
_primary.remove(primaryFunc(obj));});_upsert(obj);});domain.get=function(idFuncOrAttr,val){var matches={};if(val!==undefined){_primary.each(function(obj,key){if(obj[idFuncOrAttr]===val){matches[key]=obj;}});return matches;}else if(idFuncOrAttr instanceof Function){_primary.each(function(obj,key){if(idFuncOrAttr(obj)){matches[key]=obj;}});return matches;}
return _primary(idFuncOrAttr);};return cls;});$L.set.meth($L.Index,function Cls(constructor,primaryFunc,domain){return Lapiz.Index(Lapiz.Cls(constructor),primaryFunc,domain);});$L.Index.defaultPrimary="id";});Lapiz.Module("Obj",["Events"],function($L){var _privProto=$L.Map();$L.set.binder(_privProto,function properties(props,vals){$L.set.setProperties(this.pub,this.attr,props,vals,this.fire.change);});$L.set.binder(_privProto,function meth(name,fn){$L.set.meth(this.pub,name,fn);});$L.set.binder(_privProto,function event(name){this.fire[name]=$L.Event.linkProperty(this.pub.on,name).fire;});$L.set.binder(_privProto,function setMany(props){var property,i;var keys=Object.keys(props);var fireEnabled=this.fire.change.enabled;this.fire.change.enabled=false;for(i=keys.length-1;i>=0;i-=1){property=keys[i];this.pub[property]=props[property];}
this.fire.change.enabled=fireEnabled;this.fire.change(this.pub,keys);});$L.set.meth($L,function Obj(proto){var obj=Object.create(_privProto);obj.attr=$L.Map();obj.pub=Object.create(proto||null);_objPriv.set(obj.pub,obj);obj.fire=$L.Map();obj.pub.on=$L.Map();obj.fire['change']=$L.Event.linkProperty(obj.pub.on,'change').fire;obj.fire['remove']=$L.Event.linkProperty(obj.pub.on,'remove').fire;return obj;});var _classBuilderWM=new WeakMap();var _objPriv=new WeakMap();var _clsDefProto=$L.Map();$L.set.binder(_clsDefProto,function properties(props){var priv=_classBuilderWM.get(this);$L.each(props,function(val,key){priv.props[key]=val;});});$L.set.binder(_clsDefProto,function constructor(constructor){$L.typeCheck.func(constructor,"Constructor for class must be a function");_classBuilderWM.get(this).constructor=constructor;});$L.set.binder(_clsDefProto,function meth(name,fn){if(fn===undefined){fn=name;name=$L.getFnName(fn);}
_classBuilderWM.get(this).methods[name]=fn;});$L.set.binder(_clsDefProto,function getter(name,fn){if(fn===undefined){fn=name;name=$L.getFnName(fn);}
_classBuilderWM.get(this).getters[name]=fn;});function lateBindProp(proto,name,val){var def=$L.Map();def[name]=val;if(name[0]==="*"||name[0]==="+"){name=name.slice(1);}
$L.set.prop(proto,name,{get:function(){var priv=_objPriv.get(this);$L.set.setProperties(this,priv.attr,def,priv.fire.change);return this[name];},set:function(val){var vals=$L.Map();vals[name]=val;var priv=_objPriv.get(this);$L.set.setProperties(this,priv.attr,def,vals,priv.fire.change);},});}
function lateBindMeth(proto,name,fn){$L.set(proto,name,function(){$L.set.meth(this,name,fn,_objPriv.get(this));return this[name].apply(this,arguments);});}
function lateBindGetter(proto,name,fn){$L.set.prop(proto,name,{get:function(){var bfn=fn.bind(_objPriv.get(this))
$L.set.getter(this,name,bfn);return bfn();}});}
var _newClassEvent=$L.Event();$L.Event.linkProperty($L.on,"Cls",_newClassEvent);$L.set.meth($L,function Cls(classDef){var pub=Object.create(_clsDefProto);var priv=$L.Map();priv.props=$L.Map();priv.methods=$L.Map();priv.getters=$L.Map();_classBuilderWM.set(pub,priv);classDef.apply(pub,[pub]);var _clsProto=$L.Map();$L.each(priv.props,function(val,key){lateBindProp(_clsProto,key,val);});$L.each(priv.methods,function(val,key){lateBindMeth(_clsProto,key,val);});$L.each(priv.getters,function(val,key){lateBindGetter(_clsProto,key,val);});var _constr=priv.constructor;var constructor=function(){var self=Lapiz.Obj(_clsProto);if(_constr){self=_constr.apply(self,arguments)||self.pub;}else{self=self.pub;}
_createEvt(self);return self;};constructor.on=$L.Map();var _createEvt=$L.Event.linkProperty(constructor.on,'create').fire
_newClassEvent.fire(constructor);return constructor;});});Lapiz.Module("Parser",function($L){function resolveParser(parser){if($L.typeCheck.str(parser)&&$L.parse[parser]!==undefined){return $L.parse[parser];}
return parser;}
$L.set.meth($L,function parse(){var parser;var args=Array.prototype.slice.call(arguments,0);$L.assert(args.length>0,"Lapiz.parse requires at least one arg");var parseStrs=args.shift();if(Lapiz.typeCheck.func(parseStrs)){parser=parseStrs;}else if($L.typeCheck.str(parseStrs)){parseStrs=parseStrs.split("|");var parserName=parseStrs.pop();$L.typeCheck.func(Lapiz.parse[parserName],"Lapiz.parse."+parserName+" is not a parser");parser=Lapiz.parse[parserName];while(parseStrs.length>0){parserName=parseStrs.pop();$L.typeCheck.func(Lapiz.parse[parserName],"Lapiz.parse."+parserName+" is not a parser");parser=Lapiz.parse[parserName].call(this,parser);}}else{Lapiz.Err.toss("Lapiz.parse requires first arg as either string or function");}
if(args.length>0){return parser.apply(this,args);}
return parser;});$L.set($L.parse,"int",function(val){if(val===true){return 1;}else if(val===false){return 0;}
return parseInt(val,10);});$L.set.meth($L.parse,function string(val){if(val===undefined||val===null){return"";}
var type=typeof(val);if(type==="string"){return val;}
if(type==="number"){if(isNaN(val)){return"";}
return""+val;}
var strFromMethod;if($L.typeCheck.nested(val,"str","func")){strFromMethod=val.str();}else if($L.typeCheck.nested(val,"toString","func")){strFromMethod=val.toString();}
if(typeof strFromMethod==="string"){return strFromMethod;}
return""+val;});$L.set.meth($L.parse,function bool(val){if($L.typeCheck.str(val)&&(val==="0"||val.toLowerCase()==="false")){return false;}
return!!val;});$L.set.meth($L.parse,function strictBool(val){return!!val;});$L.set.meth($L.parse,function number(val){return parseFloat(val);});$L.set.meth($L.parse,function object(obj){return obj;});$L.set.meth($L.parse,function array(parser){parser=resolveParser(parser);return function(arr){if(Array.isArray(arr)){for(var i=0;i<arr.length;i++){arr[i]=parser(arr[i]);}
return arr;}
return[parser(arr)];};});});Lapiz.Module("Sorter",function($L){$L.set($L,"Sort",function(accessor,funcOrField){var self=function(key){return accessor(key);};$L.set(self,"_cls",$L.Sort);var _index=accessor.keys;var _sortFn;function setSortFn(funcOrField){if(funcOrField===undefined){_sortFn=function(a,b){a=accessor(a);b=accessor(b);return(a>b?1:(b>a?-1:0));};_sortFn.range=function(a,b){a=accessor(a);return(a>b?1:(b>a?-1:0));};}else if($L.typeCheck.func(funcOrField)){_sortFn=function(a,b){return funcOrField(a,b,accessor);};if($L.typeCheck.func(funcOrField.range)){_sortFn.range=function(a,b){return funcOrField.range(a,b,accessor);};}}else if($L.typeCheck.str(funcOrField)){_sortFn=function(a,b){a=accessor(a)[funcOrField];b=accessor(b)[funcOrField];return(a>b?1:(b>a?-1:0));};_sortFn.range=function(a,b){a=accessor(a)[funcOrField];return(a>b?1:(b>a?-1:0));};}else{Lapiz.Err.toss("Sorter function must be omitted, function or field name");}}
setSortFn(funcOrField);_index.sort(_sortFn);$L.set.copyProps(self,accessor,"has","Accessor","Sort","Filter","&length");$L.set.getter(self,function keys(){return _index.slice(0);});self.each=function(fn){var i;var l=_index.length;for(i=0;i<l;i+=1){key=_index[i];if(fn(accessor(key),key,self)){return key;}}};$L.set(self,"on",$L.Map());var _insertEvent=$L.Event.linkProperty(self.on,"insert");var _changeEvent=$L.Event.linkProperty(self.on,"change");var _removeEvent=$L.Event.linkProperty(self.on,"remove");Object.freeze(self.on);$L.set.setterMethod(self,function func(funcOrField){setSortFn(funcOrField)
var oldIndex=_index.slice(0);_index.sort(_sortFn);$L.each(oldIndex,function(key,oldIndex){if(_index[oldIndex]!==key){_changeEvent.fire(key,self,self(key));}});});var inFn=function(key,accessor){key=key.toString();_index.splice($L.Sort.locationOf(key,_index,_sortFn,accessor),0,key);_insertEvent.fire(key,self);};var remFn=function(key,accessor,oldVal){$L.remove(_index,key.toString());_removeEvent.fire(key,self,oldVal);};var changeFn=function(key,accessor,oldVal){key=key.toString();_index.splice(_index.indexOf(key),1);_index.splice($L.Sort.locationOf(key,_index,_sortFn,accessor),0,key);_changeEvent.fire(key,self,oldVal);};accessor.on.insert(inFn);accessor.on.remove(remFn);accessor.on.change(changeFn);self["kill"]=function(){accessor.on.insert.deregister(inFn);accessor.on.remove.deregister(remFn);accessor.on.change.deregister(changeFn);};if(_sortFn.range!==undefined){self.Range=function(a,b){b=b||a;var start=$L.Sort.locationOf(a,_index,_sortFn.range,accessor);var end=$L.Sort.gt(b,_index,_sortFn.range,accessor,start);var dict=$L.Dictionary();var i,key;for(i=start;i<end;i+=1){key=_index[i];dict(key,accessor(key));}
return dict;}}
Object.freeze(self);return self;});$L.set.meth($L.Sort,function locationOf(val,index,fn,accessor,start,end){start=start||0;end=end||index.length;var pivot=Math.floor(start+(end-start)/ 2);if(end-start===0){return start;}
if(end-start===1){return(fn(index[pivot],val,accessor)>=0)?start:end;}
return(fn(index[pivot],val,accessor)<=0)?$L.Sort.locationOf(val,index,fn,accessor,pivot,end):$L.Sort.locationOf(val,index,fn,accessor,start,pivot);});$L.set.meth($L.Sort,function gt(key,index,fn,accessor,start,end){start=start||0;end=end||index.length;var pivot=Math.floor(start+(end-start)/ 2);if(end-start===0){return start;}
if(end-start===1){return(fn(index[pivot],key,accessor)<0)?start:end;}
return(fn(index[pivot],key,accessor)<0)?$L.Sort.locationOf(key,index,fn,accessor,pivot,end):$L.Sort.locationOf(key,index,fn,accessor,start,pivot);});});