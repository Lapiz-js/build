Lapiz.Module("UI",["Collections","Events","Template","Errors"],function($L){var ui=$L.Namespace();$L.set($L,"UI",ui.namespace);var _nodeProp=new WeakMap();function _getProperties(node){var _props=_nodeProp.get(node);if(_props===undefined){_props=Lapiz.Map();_nodeProp.set(node,_props);}
return _props;}
var _views=$L.Map();var _viewAttribute='l-view';function _loadViews(){$L.each(document.querySelectorAll('['+_viewAttribute+']'),function(node){_views[node.attributes[_viewAttribute].value]=node;node.removeAttribute(_viewAttribute);node.remove();});$L.each(document.querySelectorAll(_viewAttribute),function(node){var df=document.createDocumentFragment();var name=node.attributes["name"].value;$L.assert(name!=="","Got l-view tag without name");_views[name]=df;$L.each($L.UI.Children(node),function(child){df.appendChild(child);});node.remove();});}
ui.meth(function test(){return _views["baz"];});ui.meth(function CloneView(name){if(_views[name]===undefined){$L.Err.toss("View "+name+" is not defined");}
return _views[name].cloneNode(true);});ui.meth(function View(name,viewStr){var div=document.createElement("div");div.innerHTML=viewStr;var node=div.childNodes[0];_views[name]=node;node.remove();});var _attributes=$L.Map();var _attributeOrder=[];ui.meth(function attribute(name,fn,before){if(fn===undefined||$L.typeCheck.str(fn)){if($L.typeCheck.func(name)){$L.assert(name.name!=="","Using a function as the first arg to Lapiz.UI.attribute requires a named function");before=fn;fn=name;name=fn.name;}else{$L.each(name,function(fn,name){Lapiz.UI.attribute(name,fn);});return;}}
$L.typeCheck.str(name,"Attribute name must be a string");$L.typeCheck.func(fn,"Second arg to attribute must be a function");name=name.toLocaleLowerCase();_attributes[name.toLowerCase()]=fn;if(before===undefined){_attributeOrder.push(name);}else{var idx=_attributeOrder.indexOf(before);if(idx===-1){_attributeOrder.push(name);}else{_attributeOrder.splice(idx,0,name)}}});var _mediators=$L.Map();ui.meth(function mediator(mediatorName,fn){if($L.typeCheck.func(mediatorName)){$L.assert(mediatorName.name!=="","If first argument to Lapiz.UI.mediator is a funciton, it must be named");fn=mediatorName;mediatorName=fn.name;}
$L.typeCheck.str(mediatorName,"Mediator name must be a string");$L.assert(_mediators[mediatorName]===undefined,"Attempting to redefine "+mediatorName+" mediator");var properties=$L.Map();_mediators[mediatorName]={handler:fn,properties:properties};var registerFn=function(propName,prop){if(prop===undefined){if($L.typeCheck.func(propName)&&propName.name!==""){prop=propName;propName=prop.name;}else if($L.typeCheck.arr(propName)){Lapiz.each(propName,function(fn){$L.typeCheck.func(fn,"On "+mediatorName+" found value in array that is not a function");$L.assert(fn.name!=='',"On "+mediatorName+" found unnamed function in array");properties[fn.name]=fn;});return;}else{Lapiz.each(propName,function(val,key){properties[key]=val;});return;}}
if(typeof propName!=="string"){$L.Err.toss("Mediator property name on "+mediatorName+" must be a string, got: "+(typeof propName));}
properties[propName]=prop;};$L.set($L.UI.mediator,mediatorName,registerFn);});function _attributeSorter(a,b){var ai=_attributeOrder.indexOf(a);var bi=_attributeOrder.indexOf(b);ai=ai<0?_attributeOrder.length:ai;bi=bi<0?_attributeOrder.length:bi;return ai-bi;}
function _getAttributeKeys(node){var keys=[];var i;for(i=0;i<node.attributes.length;i++){keys.push(node.attributes[i].name);}
keys.sort(_attributeSorter);return keys;}
function _inherit(node,property){var _props;for(;node!==null;node=node.parentNode){_props=_nodeProp.get(node);if(_props!==undefined&&_props[property]!==undefined){return _props[property];}}}
ui.meth(function bind(node,ctx,templator){var cur,i,attrName,attrVal,_props;if(node.nodeName.toLowerCase()==="script"){return;}
var _after=[];if($L.UI.bindState===undefined){$L.UI.bindState=$L.Map();}else{i=$L.Map();i.parent=$L.UI.bindState;$L.UI.bindState=i;}
$L.set.setterGetter($L.UI.bindState,"proceed",true,"bool");$L.set.setterMethod($L.UI.bindState,function after(fn){_after.push(fn);});_props=_getProperties(node);if(_props['firstPass']===undefined){_props['firstPass']=false;$L.set($L.UI.bindState,'firstPass',true);}else{$L.set($L.UI.bindState,'firstPass',false);}
$L.UI.bindState.ctx=(ctx===undefined)?_inherit(node,'ctx'):ctx;if(templator===undefined){templator=_inherit(node,'templator');if(templator===undefined){templator=$L.Template.Std.templator;}}
$L.UI.bindState.templator=templator;if(node.nodeType===3){if(_props["template"]===undefined){_props["template"]=node.textContent;}
i=$L.UI.bindState.templator(_props["template"],$L.UI.bindState.ctx);if($L.typeCheck(i,Node)){$L.UI.insertAfter(i,node);node.remove();}else{node.textContent=i;}}
if(node.nodeType===1){var attrTemplates=_props['attrTemplates'];if(attrTemplates===undefined){attrTemplates=$L.Map();_props['attrTemplates']=attrTemplates;}
var attrKeys=_getAttributeKeys(node);for(i=0;i<attrKeys.length;i++){attrName=attrKeys[i];if(attrTemplates[attrName]===undefined){attrTemplates[attrName]=node.attributes[attrName].value;}
attrVal=_getAttributeValue(attrTemplates[attrName],$L.UI.bindState.ctx,node,$L.UI.bindState.templator);if(_attributes[attrName]!==undefined){_attributes[attrName](node,$L.UI.bindState.ctx,attrVal);}else{node.attributes[attrName].value=attrVal;}
if($L.UI.bindState.proceed===false){break;}}}
if($L.UI.bindState.proceed){if(node.tagName&&node.tagName.toUpperCase()==="RENDER"){attrName=node.attributes.getNamedItem('name').value;i=$L.UI.CloneView(attrName);if(node.parentNode!==null){node.parentNode.insertBefore(i,node.nextSibling);$L.UI.bindState.parent.next=node.nextSibling;}
node.remove();}else if(node.nodeType===1||node.nodeType===11){for(cur=node.firstChild;cur!==null;cur=$L.UI.bindState.next){$L.UI.bindState.next=cur.nextSibling
$L.UI.bind(cur,$L.UI.bindState.ctx,$L.UI.bindState.templator);}}}
$L.each(_after,function(fn){fn();});_props['ctx']=$L.UI.bindState.ctx;_props['templator']=$L.UI.bindState.templator;$L.UI.bindState=$L.UI.bindState.parent;});var _mediatorRe=/^(\w+)\.(\w+)$/;function _getAttributeValue(str,ctx,node,templator){var mediatorPattern=_mediatorRe.exec(str);var mediator,mediatorFn;if(mediatorPattern){mediator=_mediators[mediatorPattern[1]];if(mediator){if($L.Map.has(mediator.properties,mediatorPattern[2])){return mediator.handler(node,ctx,mediator.properties[mediatorPattern[2]]);}}}
return templator(str,ctx);}
var _eventNamespace=$L.Namespace();ui.set("on",_eventNamespace.namespace);var _init=false;var _initEvent=$L.SingleEvent();$L.Event.linkProperty(_eventNamespace.namespace,"loaded",_initEvent);document.addEventListener("DOMContentLoaded",function(){new MutationObserver(function(mutations){var added=[];var removed=[];var moved=[];mutations.forEach(function(mutation){var l=mutation.removedNodes.length;var i,node,idx;for(i=0;i<l;i+=1){node=mutation.removedNodes[i];idx=added.indexOf(node);if(idx===-1){removed.push(node);}else{added.splice(idx,1);moved.push(node);}}
l=mutation.addedNodes.length;for(i=0;i<l;i+=1){node=mutation.addedNodes[i];idx=removed.indexOf(node);if(idx===-1){added.push(node);}else{removed.splice(idx,1);moved.push(node);}}});$L.each(removed,function(node){_handleDeleteNode(node);});$L.each(added,function(node){_handleAddNode(node);});}).observe(document.body,{childList:true,subtree:true});_loadViews();_init=true;_initEvent.fire();});function remove(node,fn){var _props=_getProperties(node);if(_props['onRemove']===undefined){_props['onRemove']=[];}
_props['onRemove'].push(fn);}
Object.defineProperty(remove,"deregister",{value:function(node,fn){var _props=_getProperties(node);if(_props['onRemove']===undefined){return;}
$L.remove(_props['onRemove'],fn);}});function _handleDeleteNode(node){var _props=_nodeProp.get(node);if(_props!==undefined&&_props['onRemove']!==undefined){$L.each(_props['onRemove'],function(fn){fn(node);});}
var l=node.childNodes.length;var i;for(i=0;i<l;i+=1){_handleDeleteNode(node.childNodes[i]);}}
function add(node,fn){var _props=_getProperties(node);if(_props['onAdd']===undefined){_props['onAdd']=[];}
_props['onAdd'].push(fn);}
Object.defineProperty(add,"deregister",{value:function(node,fn){var _props=_getProperties(node);if(_props['onAdd']===undefined){return;}
$L.remove(_props['onAdd'],fn);}});function _handleAddNode(node){var _props=_nodeProp.get(node);if(_props!==undefined&&_props['onAdd']!==undefined){$L.each(_props['onAdd'],function(fn){fn(node);});}
var l=node.childNodes.length;var i;for(i=0;i<l;i+=1){_handleAddNode(node.childNodes[i]);}}
function move(node,fn){var _props=_getProperties(node);if(_props['onMove']===undefined){_props['onMove']=[];}
_props['onMove'].push(fn);}
Object.defineProperty(move,"deregister",{value:function(node,fn){var _props=_getProperties(node);if(_props['onMove']===undefined){return;}
$L.remove(_props['onMove'],fn);}});function _handleMoveNode(node){var _props=_nodeProp.get(node);if(_props!==undefined&&_props['onMove']!==undefined){$L.each(_props['onMove'],function(fn){fn(node);});}
var l=node.childNodes.length;var i;for(i=0;i<l;i+=1){_handleMoveNode(node.childNodes[i]);}}
_eventNamespace.meth(remove);_eventNamespace.meth(add);_eventNamespace.meth(move);function _splitRenderString(str){var idx=str.indexOf(">");$L.assert(idx>-1,"Render string must contain >");var data=$L.Map();data.view=str.substr(0,idx).trim();data.append=false;if(str[idx+1]===">"){idx+=1;data.append=true;}
data.selector=str.substr(idx+1).trim();return data;}
ui.meth(function render(){if(!_init){var argsClsr=arguments;_initEvent.register(function(){$L.UI.render.apply(this,argsClsr);});return;}
var argsLen=arguments.length;var ctx=arguments[argsLen-1];var i,target,rend,append,view;if(typeof ctx==="string"){ctx={};}else{argsLen-=1;}
for(i=0;i<argsLen;i++){rend=_splitRenderString(arguments[i]);if(i===0){target=document.querySelector(rend.selector);if(target===null){$L.Err.toss("Got null when selecting: "+rend.selector)}
append=rend.append;view=document.createDocumentFragment();view.appendChild(Lapiz.UI.CloneView(rend.view));Lapiz.UI.bind(view,ctx,Lapiz.Template.Std.templator);}else{if(rend.selector===""){rend.target=view;}else{rend.target=view.querySelector(rend.selector);}
if(rend.target===null){test=view;$L.Err.toss("Query selector could not match "+rend.selector);}
rend.view=$L.UI.CloneView(rend.view);$L.UI.bind(rend.view,ctx,Lapiz.Template.Std.templator);if(!append){rend.target.innerHTML="";}
rend.target.appendChild(rend.view);}}
if(!append){$L.UI.empty(target);}
target.appendChild(view);});ui.meth(function id(elId,doc){return(doc||document).getElementById(elId);});ui.meth(function insertAfter(newNode,afterElement){$L.typeCheck(afterElement,Node,"insertAfter: afterElement must be a Node");$L.assert(afterElement.parentNode!==null,"insertAfter: afterElement parent cannot be null");$L.typeCheck(newNode,Node,"insertAfter: newNode must be a Node");afterElement.parentNode.insertBefore(newNode,afterElement.nextSibling);});ui.meth(function appendChild(child,parent){parent=parent||document;if($L.typeCheck.str(child)){child=child.toLowerCase();if(child==="textnode"){child=document.createTextNode("");}else{child=document.createElement(child);}}
parent.appendChild(child);return child;});ui.meth(function empty(node){if($L.typeCheck.str(node)){node=document.getElementById(node);}
$L.typeCheck(node,Node,"Lapiz.UI.empty requires either node or node ID");while(node.firstChild){node.removeChild(node.firstChild);}
return node;});ui.meth(function getStyle(node,property,doc,docView,pseudoElt){doc=doc||document;docView=docView||'defaultView';pseudoElt=pseudoElt||null;if($L.typeCheck.str(node)){node=doc.querySelector(node);}
$L.typeCheck(node,Node,"First argument to Lapiz.UI.getStyle must be node or valid selector string");var style;try{style=doc[docView].getComputedStyle(node,pseudoElt).getPropertyValue(property);}catch(err){}
return style;})
ui.meth(function Children(node){if($L.typeCheck.str(node)){node=document.querySelector(node);}
$L.typeCheck(node,Node,"Children requires node or node id");var children=[];var child;for(child=node.firstChild;child!==null;child=child.nextSibling){children.push(child);}
return children;});});Lapiz.Module("DefaultUIHelpers",["UI"],function($L){var UI=$L.UI;UI.attribute("resolver",function(node,ctx,resolver){var templator=$L.Template.Templator(UI.bindState.templator.tokenizer,resolver);UI.bindState.templator=templator;});UI.attribute("templator",function(node,ctx,templator){UI.bindState.templator=templator;});UI.attribute("with",function(node,oldCtx,newCtx){UI.bindState.ctx=newCtx;});UI.attribute("if",function(node,_,attrVal){if(typeof(attrVal)==="function"){attrVal=attrVal();}
node.removeAttribute("if");if(!attrVal){var parent=node.parentNode;parent.removeChild(node);UI.bindState.proceed=false;}});UI.attribute("ifNot",function(node,_,attrVal){if(typeof(attrVal)==="function"){attrVal=attrVal();}
node.removeAttribute("ifNot");if(attrVal){var parent=node.parentNode;parent.removeChild(node);UI.bindState.proceed=false;}});UI.attribute("repeat",function(templateNode,_,collection){var templator=UI.bindState.templator;$L.assert(collection!==undefined,"Expected collection, got undefined: "+templateNode)
var insFn,delFn;var index=$L.Map();var parent=templateNode.parentNode;var end=templateNode.ownerDocument.createComment("end of repeat");parent.insertBefore(end,templateNode);templateNode.removeAttribute("repeat");var fn=function(val,key){var clone=templateNode.cloneNode(true);index[key]=clone;UI.bind(clone,val,templator);parent.insertBefore(clone,end);};if(collection.each instanceof Function){collection.each(fn);}else{$L.each(collection,fn);}
if(collection.on!==undefined){if($L.typeCheck.func(collection.on.insert)){insFn=function(key,accessor){var clone=templateNode.cloneNode(true);var keys=accessor.keys;var i=keys.indexOf(key);if(i===keys.length-1){parent.insertBefore(clone,end);}else{parent.insertBefore(clone,index[keys[i+1]]);}
index[key]=clone;UI.bind(clone,accessor(key));};collection.on.insert(insFn);UI.on.remove(parent,function(){collection.on.insert.deregister(insFn);});}
if($L.typeCheck.func(collection.on.remove)){delFn=function(key,accessor,oldObj){var n=index[key];delete index[key];n.parentNode.removeChild(n);};collection.on.remove(delFn);Lapiz.UI.on.remove(parent,function(){collection.on.remove.deregister(delFn);});}
if($L.typeCheck.func(collection.on.change)&&delFn&&insFn){chgFn=function(key,accessor,oldVal){if(index[key]!==undefined){delFn(key,accessor,oldVal);}
insFn(key,accessor);}
collection.on.change(chgFn);UI.on.remove(parent,function(){collection.on.change.deregister(chgFn);});}}
templateNode.remove();UI.bindState.proceed=false;});var _liveNodes=new WeakMap();UI.attribute("live",function(node,context,altCtx){var ctx=altCtx||context;var fn;if($L.typeCheck.nested(ctx,"on","change","func")&&!_liveNodes.get(node)){_liveNodes.set(node,true);fn=function(){UI.bind(node);};ctx.on.change(fn);Lapiz.UI.on.remove(node,function(){ctx.on.change.deregister(fn);});}});UI.attribute({"click":function(node,_,fn){if(typeof(fn)!=="function"){$L.Err.toss("Attribute 'Click' expected function in:"+node.outerHTML);}
UI.bindState.firstPass&&node.addEventListener("click",fn);},"display":function(node,ctx,fn){if(typeof(fn)!=="function"){$L.Err.toss("Attribute 'display' expected function in:"+node.outerHTML);}
UI.bindState.firstPass&&fn(node,ctx);},"blur":function(node,_,fn){if(typeof(fn)!=="function"){$L.Err.toss("Attribute 'blur' expected function in:"+node.outerHTML);}
UI.bindState.firstPass&&node.addEventListener("blur",fn);},"submit":function(node,_,fn){if(typeof(fn)!=="function"){$L.Err.toss("Attribute 'submit' expected function in:"+node.outerHTML);}
UI.bindState.firstPass&&node.addEventListener("submit",fn);},"change":function(node,_,fn){if(typeof(fn)!=="function"){$L.Err.toss("Attribute 'change' expected function in:"+node.outerHTML);}
UI.bindState.firstPass&&node.addEventListener("change",fn);},"isChecked":function(node,ctx,bool){node.checked=!!bool;}});function _getForm(node){while(node.tagName!=="FORM"){node=node.parentNode;if(!("tagName"in node)){new Error("Node not in a form");}}
return node;}
function _getFormValues(form){var nameQuery=form.querySelectorAll("[name]");var i,n,nodeType,val,d;var data=$L.Map();for(i=nameQuery.length-1;i>=0;i-=1){n=nameQuery[i];nodeType=n.type;if(nodeType==="checkbox"||nodeType==="radio"){if(n.hasAttribute("value")){if(!n.checked){continue;}
val=n.value;}else{val=n.checked;}}else{val=n.value;}
if($L.Map.has(data,n.name)){d=data[n.name]
if($L.typeCheck.arr(d)){d.push(val);}else{data[n.name]=[d,val];}}else{data[n.name]=val;}}
return data;}
UI.mediator("form",function(node,ctx,fn){var form;return function(evt){if(form===undefined){form=_getForm(node);}
var preventDefault=true;var err=false;try{preventDefault=!fn(_getFormValues(form),form,ctx);}catch(e){err=e;}
if(preventDefault&&evt&&evt.preventDefault){evt.preventDefault();}
if(err){$L.Err.toss(err);}};});var _hash=$L.Map();UI.attribute("hash",function(node){var hash=node.getAttribute("hash");node.removeAttribute("hash");node.setAttribute("href","#"+hash);});UI.hash=function(hash,fn,ctx){var args=Array.prototype.slice.call(arguments);if(args.length===0){$L.Err.toss("Hash requires at least one arg");}
var hash=args.splice(0,1)[0];var fn=args[0];var ctx=args[1];if(args.length===0){Lapiz.each(hash,function(val,key){if(Array.isArray(val)&&val.length==2){UI.hash(key,val[0],val[1]);}else{UI.hash(key,val);}});return;}else if(typeof(args[0])==="string"){_hash[hash]=function(){UI.render.apply(this,args);};}else if(typeof(args[0])==="function"){_hash[hash]=fn;}else{return;}
var urlHash=document.location.hash.substr(1).split("/");if(hash==urlHash.shift()){UI.on.loaded(function(){_hash[hash].apply(this,urlHash);});}};window.addEventListener("popstate",function(e){if(e.target!==undefined&&e.target.location!==undefined&&e.target.location.hash!==undefined){var args=e.target.location.hash.substr(1).split("/");var hash=args.shift();if(_hash[hash]!==undefined){_hash[hash].apply(this,args);}}});UI.mediator("viewMethod",function viewMethod(node,ctx,methd){$L.typeCheck.func(methd,"Mediator viewMethod expects a function: "+node);return function innerViewMethod(){var args=Array.prototype.slice.call(arguments);args.splice(0,0,node,ctx);return methd.apply(this,args);};});var qRe={id:/\(?#(\w+)\)?/,cls:/\(?\.(\w+)\)?/g,attr:/\[(\w+)=([^\]]*)\]/g};UI.attribute("q",function(node,_,attrVal){var cls,attr,id;var clsVals=[node.className];if(clsVals[0]===''){clsVals=[];}
id=qRe.id.exec(attrVal);if(id&&node.id===""){node.id=id[1];}
while(!!(cls=qRe.cls.exec(attrVal))===true){clsVals.push(cls[1]);}
node.className=clsVals.join(' ');;while(!!(attr=qRe.attr.exec(attrVal))===true){node.setAttribute(attr[1],attr[2]);}
node.removeAttribute("q");});UI.mediator("view",function(node,ctx,viewOrGenerator){return function(){var view;var viewCtx;if(typeof(viewOrGenerator)==="function"){viewOrGenerator=viewOrGenerator(node,ctx);}
if(typeof(viewOrGenerator)==="string"){view=viewOrGenerator;viewCtx=ctx;}else{if(viewOrGenerator.view!==undefined){view=viewOrGenerator.view;viewCtx=(viewOrGenerator.ctx===undefined)?viewCtx:viewOrGenerator.ctx;}else{$L.Err.toss("An invalid view was given or generated");}}
UI.render(view,viewCtx);};});Lapiz.UI.mediator("resolver",function(node,ctx,resolverFn){return resolverFn(node,ctx);});Lapiz.UI.mediator("templator",function(node,ctx,templatorFn){return templatorFn(node,ctx);});UI.attribute("selectVal",function(node,ctx,val){node.removeAttribute("selectVal");val=$L.parse.string(val);UI.bindState.after(function(){var children=node.children;$L.each(children,function(child){if(child.tagName==="OPTION"&&child.value===val){child.selected=true;return true;}});});});UI.attribute("focus",function(node,ctx,val){UI.on.add(node,function(){node.focus();});});});