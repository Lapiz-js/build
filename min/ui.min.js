Lapiz.Module("UI",["Collections","Events","Template"],function($L){var ui=$L.Namespace();$L.set($L,"UI",ui.namespace);var _nodeProp=new WeakMap();function _getProperties(node){var _props=_nodeProp.get(node);if(_props===undefined){_props=Lapiz.Map();_nodeProp.set(node,_props);}
return _props;}
var _views=$L.Map();var _viewAttribute='l-view';function _loadViews(){$L.each(document.querySelectorAll('['+_viewAttribute+']'),function(node){_views[node.attributes[_viewAttribute].value]=node;node.removeAttribute(_viewAttribute);node.remove();});$L.each(document.querySelectorAll(_viewAttribute),function(node){var df=document.createDocumentFragment();var name=node.attributes["name"].value;$L.assert(name!=="","Got l-view tag without name");_views[name]=df;$L.each($L.UI.Children(node),function(child){df.appendChild(child);});node.remove();});}
ui.meth(function test(){return _views["baz"];});ui.meth(function CloneView(name){if(_views[name]===undefined){$L.Err.throw("View "+name+" is not defined");}
return _views[name].cloneNode(true);});ui.meth(function Children(node){if($L.typeCheck.string(node)){node=document.getElementById(node);}
$L.typeCheck(node,Node,"Children requires node or node id");var children=[];var child;for(child=node.firstChild;child!==null;child=child.nextSibling){children.push(child);}
return children;});ui.meth(function View(name,viewStr){var div=document.createElement("div");div.innerHTML=viewStr;var node=div.childNodes[0];_views[name]=node;node.remove();});var _attributes=$L.Map();var _attributeOrder=[];ui.meth(function attribute(name,fn,before){if(fn===undefined){$L.each(name,function(fn,name){Lapiz.UI.attribute(name,fn);});return;}
$L.typeCheck.string(name,"Attribute name must be a string");$L.typeCheck.func(fn,"Second arg to attribute must be a function");name=name.toLocaleLowerCase();_attributes[name.toLowerCase()]=fn;if(before===undefined){_attributeOrder.push(name);}else{var idx=_attributeOrder.indexOf(before);if(idx===-1){_attributeOrder.push(name);}else{_attributeOrder.splice(idx,0,name)}}});var _mediators=$L.Map();ui.meth(function mediator(mediatorName,fn){if(typeof mediatorName!=="string"){$L.Err.throw("Mediator name must be a string");}
if(_mediators[mediatorName]!==undefined){$L.Err.throw("Attempting to redefine "+mediatorName+" mediator");}
var properties=$L.Map();_mediators[mediatorName]={handler:fn,properties:properties};var registerFn=function(propName,prop){if(prop===undefined){Lapiz.each(propName,function(val,key){properties[key]=val;});return;}
if(typeof propName!=="string"){$L.Err.throw("Mediator property name on "+mediatorName+" must be a string, got: "+(typeof propName));}
properties[propName]=prop;};Object.defineProperty(Lapiz.UI.mediator,mediatorName,{value:registerFn});});function _attributeSorter(a,b){var ai=_attributeOrder.indexOf(a);var bi=_attributeOrder.indexOf(b);ai=ai<0?_attributeOrder.length:ai;bi=bi<0?_attributeOrder.length:bi;return ai-bi;}
function _getAttributeKeys(node){var keys=[];var i;for(i=0;i<node.attributes.length;i++){keys.push(node.attributes[i].name);}
keys.sort(_attributeSorter);return keys;}
function _inherit(node,property){var _props;for(;node!==null;node=node.parentNode){_props=_nodeProp.get(node);if(_props!==undefined&&_props[property]!==undefined){return _props[property];}}}
ui.meth(function bind(node,ctx,templator){var cur,i,attrName,attrVal,_props;if(node.nodeName.toLowerCase()==="script"){return;}
var _after=[];if($L.UI.bindState===undefined){$L.UI.bindState=$L.Map();}else{i=$L.Map();i.parent=$L.UI.bindState;$L.UI.bindState=i;}
$L.Map.setterGetter($L.UI.bindState,"proceed",true,"bool");$L.Map.setterMethod($L.UI.bindState,function after(fn){_after.push(fn);});_props=_getProperties(node);ctx=(ctx===undefined)?_inherit(node,'ctx'):ctx;_props['ctx']=ctx;if(templator===undefined){templator=_inherit(node,'templator');if(templator===undefined){templator=$L.Template.Std.templator;}}
_props['templator']=templator;$L.UI.bindState.templator=templator;if(node.nodeType===3){if(_props["template"]===undefined){_props["template"]=node.textContent;}
node.textContent=templator(_props["template"],ctx);}
if(node.nodeType===1){var attrTemplates=_props['attrTemplates'];if(attrTemplates===undefined){attrTemplates=$L.Map();_props['attrTemplates']=attrTemplates;}
var attrKeys=_getAttributeKeys(node);for(i=0;i<attrKeys.length;i++){attrName=attrKeys[i];if(attrTemplates[attrName]===undefined){attrTemplates[attrName]=node.attributes[attrName].value;}
attrVal=_getAttributeValue(attrTemplates[attrName],ctx,node,$L.UI.bindState.templator);if(_attributes[attrName]!==undefined){_attributes[attrName](node,ctx,attrVal);}else{node.attributes[attrName].value=attrVal;}
if($L.UI.bindState.proceed===false){break;}}}
if($L.UI.bindState.proceed){if(node.tagName&&node.tagName.toUpperCase()==="RENDER"){attrName=node.attributes.getNamedItem('name').value;i=$L.UI.CloneView(attrName);if(node.parentNode!==null){node.parentNode.insertBefore(i,node.nextSibling);$L.UI.bindState.parent.next=node.nextSibling;}
node.remove();}else if(node.nodeType===1||node.nodeType===11){for(cur=node.firstChild;cur!==null;cur=$L.UI.bindState.next){$L.UI.bindState.next=cur.nextSibling
$L.UI.bind(cur,ctx,$L.UI.bindState.templator);}}}
$L.each(_after,function(fn){fn();});$L.UI.bindState=$L.UI.bindState.parent;});var _mediatorRe=/^(\w+)\.(\w+)$/;function _getAttributeValue(str,ctx,node,templator){var mediatorPattern=_mediatorRe.exec(str);var mediator;if(mediatorPattern){mediator=_mediators[mediatorPattern[1]];if(mediator){return mediator.handler(node,ctx,mediator.properties[mediatorPattern[2]]);}}
return templator(str,ctx);}
var _eventNamespace=$L.Namespace();ui.set("on",_eventNamespace.namespace);var _init=false;var _initEvent=$L.SingleEvent();$L.Event.linkProperty(_eventNamespace.namespace,"loaded",_initEvent);document.addEventListener("DOMContentLoaded",function(){_loadViews();_init=true;_initEvent.fire();new MutationObserver(function(mutations){mutations.forEach(function(mutation){var l=mutation.removedNodes.length;var i;for(i=0;i<l;i+=1){_handleDeleteNode(mutation.removedNodes[i]);}});}).observe(document.body,{childList:true,subtree:true});});function _handleDeleteNode(node){var _props=_nodeProp.get(node);if(_props!==undefined&&_props['onRemove']!==undefined){$L.each(_props['onRemove'],function(fn){fn();});}
var l=node.childNodes.length;var i;for(i=0;i<l;i+=1){_handleDeleteNode(node.childNodes[i]);}}
function remove(node,fn){var _props=_getProperties(node);if(_props['onRemove']===undefined){_props['onRemove']=[];}
_props['onRemove'].push(fn);}
Object.defineProperty(remove,"deregister",{value:function(node,fn){var _props=_getProperties(node);if(_props['onRemove']===undefined){return;}
$L.remove(_props['onRemove'],fn);}});_eventNamespace.meth(remove);function _splitRenderString(str){var idx=str.indexOf(">");$L.assert(idx>-1,"Render string must contain >");var data=$L.Map();data.view=str.substr(0,idx).trim();data.append=false;if(str[idx+1]===">"){idx+=1;data.append=true;}
data.selector=str.substr(idx+1).trim();return data;}
ui.meth(function render(){if(!_init){var argsClsr=arguments;_initEvent.register(function(){$L.UI.render.apply(this,argsClsr);});return;}
var argsLen=arguments.length;var ctx=arguments[argsLen-1];var i,target,rend,append,view;if(typeof ctx==="string"){ctx={};}else{argsLen-=1;}
for(i=0;i<argsLen;i++){rend=_splitRenderString(arguments[i]);if(i===0){target=document.querySelector(rend.selector);if(target===null){$L.Err.throw("Got null when selecting: "+rend.selector)}
append=rend.append;view=document.createDocumentFragment();view.appendChild(Lapiz.UI.CloneView(rend.view));Lapiz.UI.bind(view,ctx,Lapiz.Template.Std.templator);}else{if(rend.selector===""){rend.target=view;}else{rend.target=view.querySelector(rend.selector);}
if(rend.target===null){test=view;$L.Err.throw("Query selector could not match "+rend.selector);}
rend.view=$L.UI.CloneView(rend.view);$L.UI.bind(rend.view,ctx,Lapiz.Template.Std.templator);if(!append){rend.target.innerHTML="";}
rend.target.appendChild(rend.view);}}
if(!append){target.innerHTML="";}
target.appendChild(view);});ui.meth(function id(elId,doc){return(doc||document).getElementById(elId);});$L.UI.attribute("resolver",function(node,ctx,resolver){var _props=_getProperties(node);var templator=$L.Template.Templator($L.UI.bindState.templator.tokenizer,resolver);_props["templator"]=templator;$L.UI.bindState.templator=templator;});});Lapiz.Module("DefaultUIHelpers",["UI"],function($L){var UI=$L.UI;UI.attribute("if",function(node,_,attrVal){if(typeof(attrVal)==="function"){attrVal=attrVal();}
node.removeAttribute("if");if(!attrVal){var parent=node.parentNode;parent.removeChild(node);UI.bindState.proceed=false;}});UI.attribute("ifNot",function(node,_,attrVal){if(typeof(attrVal)==="function"){attrVal=attrVal();}
node.removeAttribute("ifNot");if(attrVal){var parent=node.parentNode;parent.removeChild(node);UI.bindState.proceed=false;}});UI.attribute("repeat",function(node,_,collection){var templator=UI.bindState.templator;if(collection===undefined){throw("Expected collection, got: "+collection);}
var insFn,delFn;var index=$L.Map();var parent=node.parentNode;var end=node.ownerDocument.createComment("end of repeat");parent.insertBefore(end,node);node.removeAttribute("repeat");var nodeTemplate=node.cloneNode(true);var fn=function(val,key){var clone=nodeTemplate.cloneNode(true);index[key]=clone;UI.bind(clone,val,templator);parent.insertBefore(clone,end);};if(collection.each instanceof Function){collection.each(fn);}else{$L.each(collection,fn);}
if(collection.on!==undefined){if($L.typeCheck.func(collection.on.insert)){insFn=function(key,accessor){var clone=nodeTemplate.cloneNode(true);var keys=accessor.keys;var i=keys.indexOf(key);if(i===keys.length-1){parent.insertBefore(clone,end);}else{parent.insertBefore(clone,index[keys[i+1]]);}
index[key]=clone;UI.bind(clone,accessor(key));};collection.on.insert(insFn);UI.on.remove(parent,function(){collection.on.insert.deregister(insFn);});}
if($L.typeCheck.func(collection.on.remove)){delFn=function(key,obj,accessor){var n=index[key];delete index[key];n.parentNode.removeChild(n);};collection.on.remove(delFn);Lapiz.UI.on.remove(parent,function(){collection.on.insert.deregister(delFn);});}
if($L.typeCheck.func(collection.on.change)&&delFn&&insFn){chgFn=function(key,accessor,oldVal){delFn(key,accessor,oldVal);insFn(key,accessor);}
collection.on.change(chgFn);UI.on.remove(parent,function(){collection.on.change.deregister(chgFn);});}}
node.remove();UI.bindState.proceed=false;});var _liveNodes=new WeakMap();UI.attribute("live",function(node,context,altCtx){var ctx=altCtx||context;var fn;if($L.typeCheck.nested(ctx,"on","change","func")&&!_liveNodes.get(node)){_liveNodes.set(node,true);fn=function(){UI.bind(node);};ctx.on.change(fn);Lapiz.UI.on.remove(node,function(){ctx.on.change.deregister(fn);});}});UI.attribute({"click":function(node,_,fn){if(typeof(fn)!=="function"){$L.Err.throw("Expected function");}
node.addEventListener("click",fn);},"display":function(node,ctx,fn){if(typeof(fn)!=="function"){$L.Err.throw("Expected function");}
fn(node,ctx);},"blur":function(node,_,fn){if(typeof(fn)!=="function"){$L.Err.throw("Expected function");}
node.addEventListener("blur",fn);},"submit":function(node,_,fn){if(typeof(fn)!=="function"){$L.Err.throw("Expected function");}
node.addEventListener("submit",fn);},"change":function(node,_,fn){if(typeof(fn)!=="function"){$L.Err.throw("Expected function");}
node.addEventListener("change",fn);}});function _getForm(node){while(node.tagName!=="FORM"){node=node.parentNode;if(!("tagName"in node)){new Error("Node not in a form");}}
return node;}
function _getFormValues(form){var nameQuery=form.querySelectorAll("[name]");var i,n;var data={};for(i=nameQuery.length-1;i>=0;i-=1){n=nameQuery[i];data[n.name]=n.value;}
return data;}
UI.mediator("form",function(node,_,fn){var form;return function(evt){if(form===undefined){form=_getForm(node);}
if(!fn(_getFormValues(form))&&evt&&evt.preventDefault){evt.preventDefault();}};});var _hash=$L.Map();UI.attribute("hash",function(node){var hash=node.getAttribute("hash");node.removeAttribute("hash");node.setAttribute("href","#"+hash);});UI.hash=function(hash,fn,ctx){var args=Array.prototype.slice.call(arguments);if(args.length===0){$L.Err.throw("Hash requires at least one arg");}
var hash=args.splice(0,1)[0];var fn=args[0];var ctx=args[1];if(args.length===0){Lapiz.each(hash,function(val,key){if(Array.isArray(val)&&val.length==2){UI.hash(key,val[0],val[1]);}else{UI.hash(key,val);}});}else if(typeof(args[0])==="string"){_hash[hash]=function(){UI.render.apply(this,args);};}else if(typeof(args[0])==="function"){_hash[hash]=fn;}};window.addEventListener("popstate",function(e){if(e.target!==undefined&&e.target.location!==undefined&&e.target.location.hash!==undefined){var args=e.target.location.hash.substr(1).split("/");var hash=args.shift();if(_hash[hash]!==undefined){_hash[hash].apply(this,args);}}});UI.on.loaded(function(){var args=document.location.hash.substr(1).split("/");var hash=args.shift();if(_hash[hash]!==undefined){_hash[hash].apply(this,args);}});UI.mediator("viewMethod",function viewMethod(node,ctx,methd){return function innerViewMethod(){var args=Array.prototype.slice.call(arguments);args.splice(0,0,node,ctx);return methd.apply(this,args);};});var qRe={id:/\(?#(\w+)\)?/,cls:/\(?\.(\w+)\)?/g,attr:/\[(\w+)=([^\]]*)\]/g};UI.attribute("q",function(node,_,attrVal){var cls,attr,id;var clsVals=[node.className];if(clsVals[0]===''){clsVals=[];}
id=qRe.id.exec(attrVal);if(id&&node.id===""){node.id=id[1];}
while(!!(cls=qRe.cls.exec(attrVal))===true){clsVals.push(cls[1]);}
node.className=clsVals.join(' ');;while(!!(attr=qRe.attr.exec(attrVal))===true){node.setAttribute(attr[1],attr[2]);}
node.removeAttribute("q");});UI.mediator("view",function(node,ctx,viewOrGenerator){return function(){var view;var viewCtx;if(typeof(viewOrGenerator)==="function"){viewOrGenerator=viewOrGenerator(node,ctx);}
if(typeof(viewOrGenerator)==="string"){view=viewOrGenerator;viewCtx=ctx;}else{if(viewOrGenerator.view!==undefined){view=viewOrGenerator.view;viewCtx=(viewOrGenerator.ctx===undefined)?viewCtx:viewOrGenerator.ctx;}
$L.Err.throw("An invalid view was given or generated");}
UI.render(view,viewCtx);};});Lapiz.UI.mediator("resolver",function(node,ctx,resolverFn){return resolverFn(node,ctx);});UI.attribute("selectVal",function(node,ctx,val){node.removeAttribute("selectVal");val=$L.parse.string(val);UI.bindState.after(function(){var children=node.children;$L.each(children,function(child){if(child.tagName==="OPTION"&&child.value===val){child.selected=true;return true;}});});});});