Lapiz.Module("UI",["Collections","Events","Template"],function(s){var q=s.Namespace();s.set(s,"UI",q.namespace);var i=new WeakMap();function d(D){var C=i.get(D);if(C===undefined){C=Lapiz.Map();i.set(D,C)}return C}var y=s.Map();var l="l-view";function f(){s.each(document.querySelectorAll("["+l+"]"),function(C,D){y[D.attributes[l].value]=D;D.removeAttribute(l);D.remove()})}q.meth(function p(C){if(y[C]===undefined){throw new Error("View "+C+" is not defined")}return y[C].cloneNode(true)});q.meth(function x(D,C){var F=document.createElement("div");F.innerHTML=C;var E=F.childNodes[0];y[D]=E;E.remove()});var e=s.Map();var k=[];q.meth(function o(D,E,F){D=D.toLocaleLowerCase();if(E===undefined){s.each(D,Lapiz.UI.attribute);return}e[D.toLowerCase()]=E;if(F===undefined){k.push(D)}else{var C=k.indexOf(F);if(C===-1){k.push(D)}else{k.splice(C,0,D)}}});var n=s.Map();q.meth(function j(C,F){if(typeof C!=="string"){throw new Error("Mediator name must be a string")}if(n[C]!==undefined){throw new Error("Attempting to redefine "+C+" mediator")}var E=s.Map();n[C]={handler:F,properties:E};var D=function(G,H){if(H===undefined){Lapiz.each(G,function(I,J){E[I]=J});return}if(typeof G!=="string"){throw new Error("Mediator property name on "+C+" must be a string, got: "+(typeof G))}E[G]=H};Object.defineProperty(Lapiz.UI.mediator,C,{value:D})});function t(E,D){var C=k.indexOf(E);var F=k.indexOf(D);C=C<0?k.length:C;F=F<0?k.length:F;return C-F}function a(E){var D=[];var C;for(C=0;C<E.attributes.length;C++){D.push(E.attributes[C].name)}D.sort(t);return D}function v(D,E){var C;for(;D!==null;D=D.parentNode){C=i.get(D);if(C!==undefined&&C[E]!==undefined){return C[E]}}}q.meth(function B(D,M,F){var K,G,J,I,L;if(D.nodeName.toLowerCase()==="script"){return}var C=[];if(s.UI.bindState===undefined){s.UI.bindState=s.Map()}else{G=s.Map();G.parent=s.UI.bindState;s.UI.bindState=G}s.UI.bindState.proceed=true;s.UI.bindState.after=function(N){C.push(N)};L=d(D);if(M===undefined){M=v(D,"ctx")}else{L.ctx=M}if(F===undefined){F=v(D,"templator");if(F===undefined){F=s.Template.Std.templator}}else{L.templator=F}s.UI.bindState.templator=F;if(D.nodeType===3){if(L.template===undefined){L.template=D.textContent}D.textContent=F(L.template,M)}if(D.nodeType===1){var E=L.attrTemplates;if(E===undefined){E=s.Map();L.attrTemplates=E}var H=a(D);for(G=0;G<H.length;G++){J=H[G];if(E[J]===undefined){E[J]=D.attributes[J].value}I=b(E[J],M,D,s.UI.bindState.templator);if(e[J]!==undefined){e[J](D,M,I)}else{D.attributes[J].value=I}if(s.UI.bindState.proceed===false){break}}}if(D.nodeType===1||D.nodeType===11){for(K=D.firstChild;K!==null;K=s.UI.bindState.next){s.UI.bindState.next=K.nextSibling;s.UI.bind(K,M,s.UI.bindState.templator)}}s.each(C,function(N,O){O()});s.UI.bindState=s.UI.bindState.parent});var m=/^(\w+)\.(\w+)$/;function b(H,C,F,E){var D=m.exec(H);var G;if(D){G=n[D[1]];if(G){return G.handler(F,C,G.properties[D[2]])}}return E(H,C)}var w=s.Namespace();q.set("on",w.namespace);var h=false;var c=s.SingleEvent();s.Event.linkProperty(w.namespace,"loaded",c);document.addEventListener("DOMContentLoaded",function(){f();h=true;c.fire();new MutationObserver(function(C){C.forEach(function(E){var D=E.removedNodes.length;var F;for(F=0;F<D;F+=1){u(E.removedNodes[F])}})}).observe(document.body,{childList:true,subtree:true})});function u(F){var C=i.get(F);if(C!==undefined&&C.onRemove!==undefined){s.each(C.onRemove,function(G,H){H()})}var D=F.childNodes.length;var E;for(E=0;E<D;E+=1){u(F.childNodes[E])}}function A(E,D){var C=d(E);if(C.onRemove===undefined){C.onRemove=[]}C.onRemove.push(D)}Object.defineProperty(A,"deregister",{value:function(E,D){var C=d(E);if(C.onRemove===undefined){return}s.remove(C.onRemove,D)}});w.meth(A);function g(E){var C=E.indexOf(">");var D=s.Map();D.view=E.substr(0,C).trim();D.append=false;if(E[C+1]===">"){C+=1;D.append=true}D.selector=E.substr(C+1).trim();return D}q.meth(function z(){if(!h){var I=arguments;c.register(function(){s.UI.render.apply(this,I)});return}var G=arguments.length;var F=arguments[G-1];var H,J,D,C,E;if(typeof F==="string"){F={}}else{G-=1}for(H=0;H<G;H++){D=g(arguments[H]);if(H===0){J=document.querySelector(D.selector);C=D.append;E=document.createDocumentFragment();E.appendChild(Lapiz.UI.CloneView(D.view));Lapiz.UI.bind(E,F,Lapiz.Template.Std.templator)}else{if(D.selector===""){D.target=E}else{D.target=E.querySelector(D.selector)}if(D.target===null){test=E;throw new Error("Query selector could not match "+D.selector)}D.view=s.UI.CloneView(D.view);s.UI.bind(D.view,F,Lapiz.Template.Std.templator);if(!C){D.target.innerHTML=""}D.target.appendChild(D.view)}}if(!C){J.innerHTML=""}J.appendChild(E)});q.meth(function r(C,D){return(D||document).getElementById(C)});s.UI.attribute("resolver",function(F,D,G){var C=d(F);var E=s.Template.Templator(s.Template.Std.tokenizer,G);C.templator=E;s.UI.bindState.templator=E})});Lapiz.Module("DefaultUIHelpers",["UI"],function(e){e.UI.attribute("if",function(k,i,h){if(typeof(h)==="function"){h=h()}k.removeAttribute("if");if(!h){var j=k.parentNode;j.removeChild(k);e.UI.bindState.proceed=false}});e.UI.attribute("repeat",function(i,r,m){var l=e.UI.bindState.templator;if(m===undefined){throw ("Expected collection, got: "+m)}var h,j;var o=e.Map();var q=i.parentNode;var k=i.ownerDocument.createComment("end of repeat");q.insertBefore(k,i);i.removeAttribute("repeat");var n=i.cloneNode(true);var p=function(s,t){var u=n.cloneNode(true);o[s]=u;e.UI.bind(u,t,l);q.insertBefore(u,k)};if(m.each instanceof Function){m.each(p)}else{e.each(m,p)}if(m.on!==undefined){if(m.on.insert!==undefined){h=function(u,s){var w=n.cloneNode(true);var v=s.keys;var t=v.indexOf(u);if(t===v.length-1){q.insertBefore(w,k)}else{q.insertBefore(w,o[v[t+1]])}o[u]=w;e.UI.bind(w,s(u))};m.on.insert(h);Lapiz.UI.on.remove(q,function(){m.on.insert.deregister(h)})}if(m.on.remove!==undefined){j=function(t,u,s){var v=o[t];delete o[t];v.parentNode.removeChild(v)};m.on.remove(j);Lapiz.UI.on.remove(q,function(){m.on.insert.deregister(j)})}if(m.on.change!==undefined&&j!==undefined&&h!==undefined){chgFn=function(t,u,s){j(t,u,s);h(t,u,s)};m.on.change(chgFn);Lapiz.UI.on.remove(q,function(){m.on.change.deregister(chgFn)})}}i.parentNode.removeChild(i);e.UI.bindState.proceed=false});var f=new WeakMap();e.UI.attribute("live",function(l,j,i){var h=i||j;var k;if(h.hasOwnProperty("on")&&h.on.hasOwnProperty("change")&&!f.get(l)){f.set(l,true);k=function(){e.UI.bind(l)};h.on.change(k);Lapiz.UI.on.remove(l,function(){h.on.change.deregister(k)})}});e.UI.attribute("click",function(j,h,i){if(typeof(i)!=="function"){throw new Error("Expected function")}j.addEventListener("click",i)});e.UI.attribute("display",function(j,h,i){if(typeof(i)!=="function"){throw"Expected function"}i(j,h)});function g(h){while(h.tagName!=="FORM"){h=h.parentNode;if(!("tagName" in h)){new Error("Node not in a form")}}return h}function b(k){var h=k.querySelectorAll("[name]");var j,m;var l={};for(j=h.length-1;j>=0;j-=1){m=h[j];l[m.name]=m.value}return l}e.UI.mediator("form",function(k,h,i){var j;return function(l){if(j===undefined){j=g(k)}if(!i(b(j))&&l&&l.preventDefault){l.preventDefault()}}});var d=e.Map();e.UI.attribute("hash",function(h){var i=h.getAttribute("hash");h.removeAttribute("hash");h.setAttribute("href","#"+i)});e.UI.hash=function(k,j,h){var i=Array.prototype.slice.call(arguments);if(i.length===0){throw new Error("Hash requires at least one arg")}var k=i.splice(0,1)[0];var j=i[0];var h=i[1];if(i.length===0){Lapiz.each(k,function(l,m){if(Array.isArray(m)&&m.length==2){e.UI.hash(l,m[0],m[1])}else{e.UI.hash(l,m)}})}else{if(typeof(i[0])==="string"){d[k]=function(){e.UI.render.apply(this,i)}}else{if(typeof(i[0])==="function"){d[k]=j}}}};window.addEventListener("popstate",function(j){if(j.target!==undefined&&j.target.location!==undefined&&j.target.location.hash!==undefined){var h=j.target.location.hash.substr(1).split("/");var i=h.shift();if(d[i]!==undefined){d[i].apply(this,h)}}});e.UI.on.loaded(function(){var h=document.location.hash.substr(1).split("/");var i=h.shift();if(d[i]!==undefined){d[i].apply(this,h)}});e.UI.mediator("viewMethod",function a(j,h,k){return function i(){var l=Array.prototype.slice.call(arguments);l.splice(0,0,j,h);return k.apply(this,l)}});var c={id:/\(?#(\w+)\)?/,cls:/\(?\.(\w+)\)?/g,attr:/\[(\w+)=([^\]]*)\]/g};e.UI.attribute("q",function(l,k,j){var i,h,n;var m=[l.className];if(m[0]===""){m=[]}n=c.id.exec(j);if(n&&l.id===""){l.id=n[1]}while(!!(i=c.cls.exec(j))===true){m.push(i[1])}l.className=m.join(" ");while(!!(h=c.attr.exec(j))===true){l.setAttribute(h[1],h[2])}l.removeAttribute("q")});e.UI.mediator("view",function(j,h,i){return function(){var k;var l;if(typeof(i)==="function"){i=i(j,h)}if(typeof(i)==="string"){k=i;l=h}else{if(i.hasOwnProperty("view")){k=i.view;if(i.hasOwnProperty("ctx")){l=i.ctx}}throw new Error("An invalid view was given or generated")}e.UI.render(k,l)}});Lapiz.UI.mediator("resolver",function(j,h,i){return i(j,h)});e.UI.attribute("selectVal",function(i,h,j){i.removeAttribute("selectVal");j=e.parse.string(j);e.UI.bindState.after(function(){var k=i.children;e.each(k,function(l,m){if(m.tagName==="OPTION"&&m.value===j){m.selected=true;return true}})})});e.UI.attribute("change",function(j,h,i){if(typeof(i)!=="function"){throw"Expected function"}j.addEventListener("change",i)})});